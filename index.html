<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juego Parejas: Control Guesser</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* ESTILOS (TEMA OSCURO PRO) */
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #fce7f3; margin: 0; padding: 10px; text-align: center; }
        
        .card { background: #1e1e1e; padding: 15px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); max-width: 600px; margin: 10px auto; border: 1px solid #333; }
        
        button { width: 100%; padding: 14px; background: #be185d; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 15px; transition: 0.2s; }
        button:disabled { background: #444; color: #888; opacity: 0.5; }
        button:active { transform: scale(0.98); }
        
        input { width: 100%; padding: 12px; background: #333; border: 2px solid #555; border-radius: 10px; color: white; text-align: center; font-size: 16px; outline: none; margin-bottom: 10px; }
        input:focus { border-color: #be185d; }
        
        /* GRID DE COLORES */
        .grid-wrapper { overflow-x: auto; padding-bottom: 10px; display: flex; justify-content: center; }
        .color-grid { 
            display: grid; 
            grid-template-columns: repeat(20, 1fr); 
            gap: 1px; 
            background: #000; 
            padding: 2px; 
            border-radius: 6px; 
            min-width: 340px;
        }
        .color-cell { aspect-ratio: 1; border-radius: 1px; cursor: pointer; position: relative; }
        
        /* COORDENADAS */
        .coord-box { background: #be185d; color: white; padding: 5px 15px; border-radius: 5px; font-weight: bold; display: inline-block; margin-bottom: 10px; font-size: 24px; letter-spacing: 2px; border: 2px solid #fbcfe8; }
        
        /* MARCAS */
        .target-star::after { content: "‚òÖ"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 10px; text-shadow: 0 0 3px black; pointer-events: none; }
        
        .guess-mark-1 { border: 2px solid rgba(255,255,255,0.5); z-index: 5; } 
        .guess-mark-current { box-shadow: 0 0 0 2px white, 0 0 10px #be185d; z-index: 10; transform: scale(1.15); border-radius: 2px; }

        /* NOTIFICACIONES */
        .hint-display { background: #333; padding: 10px; border-radius: 8px; font-style: italic; border-left: 4px solid #be185d; margin: 10px 0; text-align: left; }
        .waiting-pulse { color: #888; font-style: italic; animation: pulse 1.5s infinite; margin-top: 15px; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        /* CHAT */
        .chat-btn { position: fixed; top: 15px; right: 15px; width: 45px; height: 45px; background: #be185d; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 100; border: 2px solid white; box-shadow: 0 4px 10px black; }
        .chat-overlay { position: fixed; bottom: 0; left: 0; right: 0; height: 50vh; background: #222; border-top: 2px solid #be185d; z-index: 99; display: flex; flex-direction: column; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CLAVES FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCbKOu5vwGbowuI5CfbygKJtYujAKa6zJ0",
          authDomain: "juegos-tiktok.firebaseapp.com",
          databaseURL: "https://juegos-tiktok-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "juegos-tiktok",
          storageBucket: "juegos-tiktok.firebasestorage.app",
          messagingSenderId: "504168913042",
          appId: "1:504168913042:web:e9eba88e01f94bcc7a2e4b"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. CONFIGURACI√ìN DEL JUEGO ---
        const COLS = 20; 
        const ROWS = 15; 
        const ROW_LABELS = "ABCDEFGHIJKLMNO".split('');

        const getColor = (r, c) => {
            const hue = Math.floor((360 / COLS) * c);
            let sat = 100, light = 50;
            if (r < 5) { light = 100 - (r * 10); sat = 50 + (r * 10); } 
            else if (r > 9) { light = 50 - ((r - 9) * 8); } 
            return `hsl(${hue}, ${sat}%, ${light}%)`;
        };

        const ColorGame = ({ roomId, playerRole, roomData }) => {
            const game = roomData.colorGame || {};
            
            // L√≥gica de roles
            const isHostTurn = game.turn === 'host'; 
            const amIHost = playerRole === 'host';
            const iAmGiver = (isHostTurn && amIHost) || (!isHostTurn && !amIHost); // Yo doy la pista
            const iAmGuesser = !iAmGiver; // Yo adivino y ELIJO

            const actorName = isHostTurn ? roomData.players.host.name : roomData.players.guest.name; 
            
            // --- FUNCIONES DEL JUEGO ---

            const startTurn = () => {
                const nextTurn = (!game.turn || game.turn === 'guest') ? 'host' : 'guest';
                
                const r = Math.floor(Math.random() * ROWS);
                const c = Math.floor(Math.random() * COLS);
                const code = `${ROW_LABELS[r]}-${c + 1}`;

                db.ref(`salas/${roomId}/colorGame`).set({
                    turn: nextTurn,
                    target: { r, c, code },
                    step: 1, 
                    hints: { h1: '', h2: '' },
                    guesses: { g1: null, g2: null }, 
                    currentCursor: null, 
                    score: 0
                });
            };

            const sendHint = (text) => {
                if(!text) return;
                const update = {};
                if (game.step === 1) update['hints/h1'] = text;
                if (game.step === 3) update['hints/h2'] = text;
                
                update['step'] = (game.step || 1) + 1; 
                update['currentCursor'] = null; 
                db.ref(`salas/${roomId}/colorGame`).update(update);
            };

            const touchGrid = (r, c) => {
                if (!iAmGuesser) return; 
                if (game.step !== 2 && game.step !== 4) return; 
                
                db.ref(`salas/${roomId}/colorGame`).update({ currentCursor: {r, c} });
            };

            const confirmGuess = () => {
                if (!game.currentCursor) return alert("Marca un color en el mapa primero.");
                
                const update = {};
                if (game.step === 2) {
                    update['guesses/g1'] = game.currentCursor;
                    update['step'] = 3; 
                } else if (game.step === 4) {
                    update['guesses/g2'] = game.currentCursor;
                    update['step'] = 5; 
                    
                    const tr = game.target.r; const tc = game.target.c;
                    const gr = game.currentCursor.r; const gc = game.currentCursor.c;
                    const dist = Math.max(Math.abs(tr - gr), Math.abs(tc - gc));
                    
                    let pts = 0;
                    if (dist === 0) pts = 3;
                    else if (dist <= 1) pts = 2;
                    else if (dist <= 3) pts = 1;
                    update['score'] = pts;
                }
                update['currentCursor'] = null;
                db.ref(`salas/${roomId}/colorGame`).update(update);
            };

            // --- RENDERIZADO ---

            // Pantalla de Inicio
            if (!game.turn) {
                return (
                    <div className="card">
                        <h2>üé® Modo 2 Rondas</h2>
                        <p>Objetivo aleatorio. 2 Oportunidades.</p>
                        {amIHost ? 
                            <button onClick={startTurn}>INICIAR PARTIDA</button> : 
                            <p className="waiting-pulse">Esperando al Host...</p>}
                    </div>
                );
            }

            // Protecci√≥n contra pantalla negra
            if (!game.target) return <div className="card"><p>Cargando ronda...</p></div>;

            return (
                <div className="card" style={{maxWidth:'100%', padding:10}}>
                    
                    <div style={{display:'flex', justifyContent:'space-between', fontSize:12, color:'#888', marginBottom:10}}>
                        <span>TURNO: {actorName}</span>
                        <span>PASO: {game.step}/5</span>
                    </div>

                    {/* ZONA DE QUIEN DA LAS PISTAS (GIVER) */}
                    {iAmGiver && (
                        <div>
                            {game.step < 5 && (
                                <div style={{background:'#333', padding:10, borderRadius:8, marginBottom:10}}>
                                    <div style={{fontSize:12}}>TU OBJETIVO:</div>
                                    <div className="coord-box">{game.target?.code}</div>
                                    <div style={{height:20, background:getColor(game.target.r, game.target.c), width:'100%', borderRadius:4}}></div>
                                </div>
                            )}

                            {/* Pista 1 */}
                            {game.step === 1 && (
                                <div>
                                    <p>1. Escribe la primera pista:</p>
                                    <input id="h1" placeholder="Ej: Es verde..." />
                                    <button onClick={()=>sendHint(document.getElementById('h1').value)}>ENVIAR PISTA 1</button>
                                </div>
                            )}

                            {/* Esperando confirmaci√≥n 1 */}
                            {game.step === 2 && (
                                <div>
                                    <p className="waiting-pulse">Tu pareja est√° decidiendo y confirmando...</p>
                                    {game.currentCursor && <p style={{fontSize:12, color:'#10b981'}}>¬°Est√° tocando el mapa!</p>}
                                </div>
                            )}

                            {/* Pista 2 */}
                            {game.step === 3 && (
                                <div>
                                    <div className="hint-display" style={{opacity:0.6}}>Pista 1: {game.hints?.h1}</div>
                                    <p>2. ¬°Dales otra oportunidad! Pista 2:</p>
                                    <input id="h2" placeholder="Ej: M√°s oscuro..." />
                                    <button onClick={()=>sendHint(document.getElementById('h2').value)}>ENVIAR PISTA 2</button>
                                </div>
                            )}

                            {/* Esperando confirmaci√≥n 2 */}
                            {game.step === 4 && (
                                <div>
                                    <p className="waiting-pulse">Tu pareja est√° decidiendo el final...</p>
                                    {game.currentCursor && <p style={{fontSize:12, color:'#10b981'}}>¬°Est√° tocando el mapa!</p>}
                                </div>
                            )}
                        </div>
                    )}

                    {/* ZONA DE QUIEN ADIVINA Y CONFIRMA (GUESSER) */}
                    {iAmGuesser && (
                        <div>
                            {/* Esperando que escriban la pista */}
                            {(game.step === 1 || game.step === 3) && (
                                <div style={{padding:20, color:'#888', fontStyle:'italic'}}>
                                    Esperando pista de tu pareja...
                                </div>
                            )}

                            {/* Elegir y Confirmar 1 */}
                            {game.step === 2 && (
                                <div>
                                    <div className="hint-display">Pista 1: <b>{game.hints?.h1}</b></div>
                                    <p style={{color:'#10b981'}}>1. ELIGE Y CONFIRMA</p>
                                    <button onClick={confirmGuess} disabled={!game.currentCursor} style={{background: game.currentCursor ? '#be185d' : '#444'}}>
                                        CONFIRMAR ELECCI√ìN
                                    </button>
                                </div>
                            )}

                            {/* Elegir y Confirmar 2 */}
                            {game.step === 4 && (
                                <div>
                                    <div className="hint-display">Pista 2: <b>{game.hints?.h2}</b></div>
                                    <p style={{color:'#10b981'}}>2. ELIGE Y TERMINA</p>
                                    <button onClick={confirmGuess} disabled={!game.currentCursor} style={{background: game.currentCursor ? '#be185d' : '#444'}}>
                                        CONFIRMAR FINAL
                                    </button>
                                </div>
                            )}
                        </div>
                    )}

                    {/* RESULTADOS (Paso 5) */}
                    {game.step === 5 && (
                        <div style={{margin:'20px 0'}}>
                            <div style={{fontSize:50, fontWeight:900, color: game.score===3?'#10b981':'#fbbf24'}}>+{game.score} PUNTOS</div>
                            <div style={{display:'flex', justifyContent:'center', gap:10, marginTop:10}}>
                                <div>REAL<br/><div className="coord-box" style={{fontSize:14}}>{game.target?.code}</div></div>
                                <div style={{width:40, height:40, background:getColor(game.target.r, game.target.c), border:'2px solid white', borderRadius:5}}></div>
                            </div>
                            
                            {/* EL GUESSER TIENE EL BOT√ìN DE SIGUIENTE */}
                            {iAmGuesser ? (
                                <button onClick={startTurn}>SIGUIENTE TURNO ‚û§</button>
                            ) : (
                                <p className="waiting-pulse">Tu pareja est√° viendo el resultado...</p>
                            )}
                        </div>
                    )}

                    {/* TABLERO */}
                    <div className="grid-wrapper">
                        <div className="color-grid">
                            {Array.from({ length: COLS * ROWS }).map((_, i) => {
                                const r = Math.floor(i / COLS);
                                const c = i % COLS;
                                const color = getColor(r, c);

                                const isTarget = (iAmGiver || game.step === 5) && game.target?.r === r && game.target?.c === c;
                                const isCursor = game.currentCursor && game.currentCursor.r === r && game.currentCursor.c === c;
                                const isGuess1 = game.guesses?.g1 && game.guesses.g1.r === r && game.guesses.g1.c === c;
                                const isGuess2 = game.guesses?.g2 && game.guesses.g2.r === r && game.guesses.g2.c === c;

                                let classes = "color-cell";
                                if (isTarget) classes += " target-star";
                                if (isCursor) classes += " guess-mark-current";
                                if (isGuess1) classes += " guess-mark-1"; 
                                if (isGuess2 && game.step === 5) classes += " guess-mark-current";

                                return (
                                    <div 
                                        key={i} 
                                        className={classes}
                                        style={{ backgroundColor: color }}
                                        onClick={() => touchGrid(r, c)}
                                    ></div>
                                );
                            })}
                        </div>
                    </div>

                </div>
            );
        };

        // --- APP SHELL ---
        function App() {
            const [view, setView] = React.useState('lobby');
            const [playerName, setPlayerName] = React.useState(localStorage.getItem('name') || '');
            const [roomId, setRoomId] = React.useState('');
            const [playerRole, setPlayerRole] = React.useState('');
            const [roomData, setRoomData] = React.useState(null);
            
            const [showChat, setShowChat] = React.useState(false);
            const [chatMsg, setChatMsg] = React.useState('');
            const [messages, setMessages] = React.useState([]);

            React.useEffect(() => { localStorage.setItem('name', playerName); }, [playerName]);

            React.useEffect(() => {
                if (roomId) {
                    db.ref('salas/' + roomId).on('value', snap => {
                        const data = snap.val();
                        if (data) {
                            setRoomData(data);
                            if (view === 'waiting' && data.players.guest) setView('game');
                            if (data.chat) setMessages(Object.values(data.chat));
                        }
                    });
                }
            }, [roomId, view]);

            const createRoom = () => {
                const id = Math.random().toString(36).substring(2,6).toUpperCase();
                db.ref('salas/'+id).set({ players: { host: { name: playerName } }, gameState: 'LOBBY' });
                setRoomId(id); setPlayerRole('host'); setView('waiting');
            };

            const joinRoom = (code) => {
                db.ref('salas/'+code).once('value', snap => {
                    if(snap.exists()) {
                        db.ref('salas/'+code+'/players/guest').set({ name: playerName });
                        setRoomId(code); setPlayerRole('guest'); setView('game');
                    }
                });
            };

            const sendChat = () => {
                if(!chatMsg) return;
                db.ref('salas/'+roomId+'/chat').push({ user: playerName, text: chatMsg });
                setChatMsg('');
            };

            return (
                <div>
                    {roomId && (
                        <>
                            <div className="chat-btn" onClick={() => setShowChat(!showChat)}>üí¨</div>
                            {showChat && (
                                <div className="chat-overlay">
                                    <div style={{flex:1, overflowY:'auto', padding:20, textAlign:'left'}}>
                                        {messages.map((m,i) => <div key={i} style={{marginBottom:8}}><b>{m.user}:</b> {m.text}</div>)}
                                    </div>
                                    <div style={{display:'flex', padding:10, background:'#333'}}>
                                        <input value={chatMsg} onChange={e=>setChatMsg(e.target.value)} style={{marginBottom:0, flex:1}} placeholder="..."/>
                                        <button onClick={sendChat} style={{width:'auto', margin:'0 0 0 5px', padding:'0 15px'}}>‚û§</button>
                                    </div>
                                    <button onClick={()=>setShowChat(false)} style={{margin:0, borderRadius:0, padding:10, background:'#111'}}>CERRAR</button>
                                </div>
                            )}
                        </>
                    )}

                    {view === 'lobby' && (
                        <div className="card">
                            <h1>Parejas ‚ù§Ô∏è</h1>
                            <input value={playerName} onChange={e=>setPlayerName(e.target.value)} placeholder="Tu Nombre" />
                            <button onClick={createRoom}>Crear Sala</button>
                            <input id="c" placeholder="C√ìDIGO" style={{textTransform:'uppercase', marginTop:20}}/>
                            <button style={{background:'#6366f1'}} onClick={()=>joinRoom(document.getElementById('c').value.toUpperCase())}>Unirse</button>
                        </div>
                    )}

                    {view === 'waiting' && <div className="card"><h2>{roomId}</h2><p>Esperando...</p></div>}

                    {view === 'game' && roomData && <ColorGame roomId={roomId} playerRole={playerRole} roomData={roomData} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
