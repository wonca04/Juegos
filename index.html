<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juego Parejas Pro ‚ù§Ô∏è</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* ESTILOS GENERALES */
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a1a; color: #fce7f3; margin: 0; padding: 10px; text-align: center; }
        
        .card { background: #2d2d2d; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); max-width: 600px; margin: 5px auto; border: 1px solid #444; }
        
        /* Botones estilo App */
        button { width: 100%; padding: 14px; background: #db2777; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 15px; box-shadow: 0 4px 0 #9d174d; transition: 0.1s; }
        button:active { transform: translateY(4px); box-shadow: none; }
        button:disabled { background: #555; box-shadow: none; opacity: 0.6; color: #888; transform: none; }
        
        input { width: 100%; padding: 12px; background: #404040; border: 2px solid #555; border-radius: 10px; color: white; text-align: center; font-size: 16px; margin-bottom: 10px; outline: none; }
        input:focus { border-color: #db2777; }
        
        /* GRID DE ALTA DEFINICI√ìN */
        .grid-container { overflow-x: auto; padding-bottom: 10px; }
        .color-grid { 
            display: grid; 
            grid-template-columns: repeat(20, 1fr); /* 20 Columnas (Matiz) */
            gap: 1px; 
            margin-top: 10px; 
            background: #000; 
            padding: 2px; 
            border-radius: 8px; 
            min-width: 320px; /* Asegura que no se aplaste en m√≥viles muy peque√±os */
        }
        .color-cell { 
            aspect-ratio: 1; 
            border-radius: 1px; 
            position: relative; 
            cursor: pointer;
        }
        
        /* MARCAS Y CURSORES */
        /* Marca del Objetivo (Estrella) */
        .target-mark::after { content: "‚òÖ"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 10px; text-shadow: 0 0 2px black, 0 0 4px black; pointer-events: none; }
        
        /* Selecci√≥n Temporal (Borde animado) */
        .selected-temp { 
            box-shadow: inset 0 0 0 2px white, 0 0 5px 2px rgba(255,255,255,0.8); 
            z-index: 10; 
            transform: scale(1.1); 
            border-radius: 3px;
            transition: transform 0.1s;
        }

        /* TEXTOS Y AVISOS */
        .phase-badge { display: inline-block; background: #500724; color: #fbcfe8; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 10px; border: 1px solid #db2777; }
        .big-text { font-size: 18px; font-weight: bold; margin: 10px 0; color: #fff; }
        .waiting-pulse { animation: pulse 1.5s infinite; color: #aaa; font-style: italic; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* CHAT FLOTANTE */
        .chat-btn { position: fixed; top: 15px; right: 15px; background: #db2777; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 100; font-size: 20px; border: 2px solid white; cursor: pointer; }
        .chat-box { position: fixed; top: 70px; right: 10px; left: 10px; height: 300px; background: #2d2d2d; border: 2px solid #db2777; border-radius: 15px; z-index: 99; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CLAVES DE FIREBASE (YA PUESTAS) ---
        const firebaseConfig = {
          apiKey: "AIzaSyCbKOu5vwGbowuI5CfbygKJtYujAKa6zJ0",
          authDomain: "juegos-tiktok.firebaseapp.com",
          databaseURL: "https://juegos-tiktok-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "juegos-tiktok",
          storageBucket: "juegos-tiktok.firebasestorage.app",
          messagingSenderId: "504168913042",
          appId: "1:504168913042:web:e9eba88e01f94bcc7a2e4b"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. L√ìGICA DE COLOR (Alta Variedad) ---
        const COLS = 20; // Variedad de tonos (Hue)
        const ROWS = 15; // Variedad de luz/saturaci√≥n
        
        // Generador de color estilo "Mapa de Espectro"
        const getColor = (r, c) => {
            const hue = Math.floor((360 / COLS) * c); // El matiz cambia por columnas
            
            // La fila define la luminosidad y saturaci√≥n
            // Filas superiores (0-3): Casi blanco a color pastel
            // Filas medias (4-10): Color puro
            // Filas inferiores (11-14): Color oscuro a casi negro
            
            let sat = 100;
            let light = 50;

            if (r < 5) {
                // Zona Clara (Blanco -> Color)
                light = 100 - (r * 10); 
                sat = 50 + (r * 10);
            } else if (r > 9) {
                // Zona Oscura (Color -> Negro)
                light = 50 - ((r - 9) * 10);
            } else {
                // Zona Media (Vibrante)
                light = 50;
            }

            return `hsl(${hue}, ${sat}%, ${light}%)`;
        };

        // --- 3. JUEGO ---
        const ColorGame = ({ roomId, playerRole, roomData }) => {
            const game = roomData.colorGame || {};
            
            // Roles y Turnos
            // ¬øQui√©n pone el color? (Host en turno Host, Guest en turno Guest)
            const isSetter = game.turn === playerRole; 
            const isGuesser = game.turn && game.turn !== playerRole;
            
            // Nombre visual
            const currentTurnName = game.turn === 'host' ? roomData.players.host.name : roomData.players.guest.name;

            // --- FUNCIONES ---

            // 1. Empezar nueva ronda (Reset)
            const startNewRound = () => {
                const nextPlayer = (!game.turn || game.turn === 'guest') ? 'host' : 'guest';
                db.ref(`salas/${roomId}/colorGame`).set({
                    turn: nextPlayer,
                    phase: 'SETUP', // SETUP (Elegir color) -> HINTING (Pista) -> GUESSING (Adivinar) -> RESULT
                    tempTarget: null, // Donde est√° tocando el que elige
                    target: null,     // El color elegido final
                    tempGuess: null,  // Donde est√° tocando el que adivina
                    guess: null,      // El color adivinado final
                    hint: '',
                    score: 0
                });
            };

            // 2. Click en el tablero
            const handleCellClick = (r, c) => {
                // FASE 1: El Host elige el color objetivo
                if (game.phase === 'SETUP' && isSetter) {
                    db.ref(`salas/${roomId}/colorGame`).update({ tempTarget: {r, c} });
                }
                // FASE 3: El Guest intenta adivinar
                if (game.phase === 'GUESSING' && isGuesser) {
                    db.ref(`salas/${roomId}/colorGame`).update({ tempGuess: {r, c} });
                }
            };

            // 3. Botones de confirmar
            const confirmTarget = () => {
                if (!game.tempTarget) return alert("Selecciona un color primero");
                // Guardamos el objetivo fijo y pasamos a dar pista
                db.ref(`salas/${roomId}/colorGame`).update({ 
                    target: game.tempTarget,
                    phase: 'HINTING' 
                });
            };

            const sendHint = (text) => {
                if (!text) return alert("Escribe algo...");
                db.ref(`salas/${roomId}/colorGame`).update({ 
                    hint: text, 
                    phase: 'GUESSING' 
                });
            };

            const confirmGuess = () => {
                if (!game.tempGuess) return alert("Selecciona un color primero");
                
                // Calcular puntos
                const tr = game.target.r; const tc = game.target.c;
                const gr = game.tempGuess.r; const gc = game.tempGuess.c;
                
                // Distancia euclidiana aproximada
                const dist = Math.sqrt(Math.pow(tr - gr, 2) + Math.pow(tc - gc, 2));
                
                let points = 0;
                if (dist < 1.5) points = 3;      // Exacto o pegado
                else if (dist < 3.5) points = 2; // Cerca
                else if (dist < 6) points = 1;   // Algo lejos
                
                db.ref(`salas/${roomId}/colorGame`).update({ 
                    guess: game.tempGuess,
                    score: points,
                    phase: 'RESULT'
                });
            };

            // --- VISTA INICIAL ---
            if (!game.turn) {
                return (
                    <div className="card">
                        <h2>üé® Paleta Pro</h2>
                        <p>Turnos manuales. Elige color, da pista, adivina.</p>
                        {playerRole === 'host' ? 
                            <button onClick={startNewRound}>EMPEZAR JUEGO</button> : 
                            <p className="waiting-pulse">Esperando al Host...</p>}
                    </div>
                );
            }

            // --- RENDERIZADO DEL JUEGO ---
            return (
                <div className="card" style={{maxWidth:'100%', padding:'10px'}}>
                    
                    <div className="phase-badge">{game.phase === 'SETUP' ? 'ELIGIENDO COLOR' : (game.phase === 'HINTING' ? 'ESCRIBIENDO PISTA' : (game.phase === 'GUESSING' ? 'ADIVINANDO' : 'RESULTADO'))}</div>
                    <div style={{color:'#aaa', fontSize:'14px', marginBottom:'10px'}}>Turno de: <b style={{color:'white'}}>{currentTurnName}</b></div>

                    {/* ZONA DE CONTROLES (Arriba del tablero) */}
                    
                    {/* FASE 1: SETUP (Elegir Objetivo) */}
                    {game.phase === 'SETUP' && isSetter && (
                        <div>
                            <div className="big-text">1. Toca la paleta para elegir color</div>
                            <div style={{height:30, width:'100%', background: game.tempTarget ? getColor(game.tempTarget.r, game.tempTarget.c) : '#333', borderRadius:5, marginBottom:10, border:'1px solid #fff'}}></div>
                            <button onClick={confirmTarget} disabled={!game.tempTarget}>CONFIRMAR OBJETIVO ‚û§</button>
                        </div>
                    )}
                    {game.phase === 'SETUP' && !isSetter && <p className="waiting-pulse">Tu pareja est√° eligiendo un color secreto...</p>}


                    {/* FASE 2: PISTA */}
                    {game.phase === 'HINTING' && isSetter && (
                        <div>
                            <div className="big-text">2. Da una pista para este color</div>
                            <div style={{height:30, width:'100%', background: getColor(game.target.r, game.target.c), borderRadius:5, marginBottom:10}}></div>
                            <input id="hintInput" placeholder="Ej: Ojos de tu gato..." />
                            <button onClick={()=>sendHint(document.getElementById('hintInput').value)}>MANDAR PISTA</button>
                        </div>
                    )}
                    {game.phase === 'HINTING' && !isSetter && <p className="waiting-pulse">Esperando la pista...</p>}


                    {/* FASE 3: ADIVINAR */}
                    {game.phase === 'GUESSING' && (
                        <div style={{background:'#500724', padding:10, borderRadius:10, marginBottom:10, border:'1px solid #db2777'}}>
                            <span style={{color:'#fbcfe8', fontSize:12}}>PISTA:</span><br/>
                            <span style={{fontSize:20, fontWeight:'bold', color:'white'}}>"{game.hint}"</span>
                        </div>
                    )}
                    {game.phase === 'GUESSING' && isGuesser && (
                        <div>
                             <p>Toca la paleta para buscar el color.</p>
                             <button onClick={confirmGuess} disabled={!game.tempGuess}>CONFIRMAR RESPUESTA ‚û§</button>
                        </div>
                    )}
                    {game.phase === 'GUESSING' && isSetter && <p className="waiting-pulse">Mira c√≥mo mueve el cursor tu pareja...</p>}


                    {/* FASE 4: RESULTADO */}
                    {game.phase === 'RESULT' && (
                        <div>
                            <div style={{fontSize:40, fontWeight:900, color: game.score > 0 ? '#4ade80' : '#f87171', textShadow:'0 2px 10px rgba(0,0,0,0.5)'}}>
                                {game.score === 3 ? '¬°PERFECTO!' : (game.score === 2 ? '¬°MUY BIEN!' : (game.score === 1 ? 'CERCA...' : 'LEJOS'))}
                            </div>
                            <div style={{display:'flex', justifyContent:'center', gap:10, margin:'10px 0'}}>
                                <div>OBJETIVO<br/><div style={{width:40, height:40, background:getColor(game.target.r, game.target.c), borderRadius:5, border:'1px solid white'}}></div></div>
                                <div>INTENTO<br/><div style={{width:40, height:40, background:getColor(game.guess.r, game.guess.c), borderRadius:5, border:'1px solid white'}}></div></div>
                            </div>
                            <button onClick={startNewRound}>SIGUIENTE TURNO ‚Üª</button>
                        </div>
                    )}


                    {/* --- TABLERO (Siempre visible pero interactivo seg√∫n fase) --- */}
                    <div className="grid-container">
                        <div className="color-grid">
                            {Array.from({ length: COLS * ROWS }).map((_, i) => {
                                const r = Math.floor(i / COLS);
                                const c = i % COLS;
                                const color = getColor(r, c);

                                // L√ìGICA DE VISUALIZACI√ìN DE MARCAS
                                let isTarget = false;
                                let isTempTarget = false;
                                let isTempGuess = false;
                                let isFinalGuess = false;

                                // 1. Mostrar objetivo (Estrella)
                                // El Host siempre ve su objetivo (temp o final)
                                if (isSetter || game.phase === 'RESULT') {
                                    if (game.target && game.target.r === r && game.target.c === c) isTarget = true;
                                    if (game.phase === 'SETUP' && game.tempTarget && game.tempTarget.r === r && game.tempTarget.c === c) isTempTarget = true;
                                }

                                // 2. Mostrar intento (Borde)
                                // Ambos ven el intento en tiempo real (tempGuess)
                                if (game.phase === 'GUESSING' && game.tempGuess && game.tempGuess.r === r && game.tempGuess.c === c) isTempGuess = true;
                                if (game.phase === 'RESULT' && game.guess && game.guess.r === r && game.guess.c === c) isFinalGuess = true;

                                return (
                                    <div 
                                        key={i} 
                                        className={`color-cell ${isTarget ? 'target-mark' : ''} ${(isTempGuess || isFinalGuess || isTempTarget) ? 'selected-temp' : ''}`}
                                        style={{ backgroundColor: color }}
                                        onClick={() => handleCellClick(r, c)}
                                    ></div>
                                );
                            })}
                        </div>
                    </div>

                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [view, setView] = React.useState('lobby');
            const [playerName, setPlayerName] = React.useState(localStorage.getItem('name') || '');
            const [roomId, setRoomId] = React.useState('');
            const [playerRole, setPlayerRole] = React.useState('');
            const [roomData, setRoomData] = React.useState(null);
            
            // Chat
            const [showChat, setShowChat] = React.useState(false);
            const [chatMsg, setChatMsg] = React.useState('');
            const [messages, setMessages] = React.useState([]);

            React.useEffect(() => { localStorage.setItem('name', playerName); }, [playerName]);

            React.useEffect(() => {
                if (roomId) {
                    db.ref('salas/' + roomId).on('value', snap => {
                        const data = snap.val();
                        if (data) {
                            setRoomData(data);
                            if (view === 'waiting' && data.players.guest) setView('game');
                            if (data.chat) setMessages(Object.values(data.chat));
                        }
                    });
                }
            }, [roomId, view]);

            const createRoom = () => {
                const id = Math.random().toString(36).substring(2,6).toUpperCase();
                db.ref('salas/'+id).set({ players: { host: { name: playerName } }, gameState: 'LOBBY' });
                setRoomId(id); setPlayerRole('host'); setView('waiting');
            };

            const joinRoom = (code) => {
                db.ref('salas/'+code).once('value', snap => {
                    if(snap.exists()) {
                        db.ref('salas/'+code+'/players/guest').set({ name: playerName });
                        setRoomId(code); setPlayerRole('guest'); setView('game');
                    }
                });
            };

            const sendChat = () => {
                if(!chatMsg) return;
                db.ref('salas/'+roomId+'/chat').push({ user: playerName, text: chatMsg });
                setChatMsg('');
            };

            return (
                <div>
                    {roomId && (
                        <>
                            <div className="chat-btn" onClick={() => setShowChat(!showChat)}>üí¨</div>
                            {showChat && (
                                <div className="chat-box">
                                    <div style={{flex:1, overflowY:'auto', padding:10, textAlign:'left', color:'white'}}>
                                        {messages.map((m,i) => <div key={i} style={{marginBottom:5}}><b>{m.user}:</b> {m.text}</div>)}
                                    </div>
                                    <div style={{display:'flex', padding:10, background:'#444'}}>
                                        <input value={chatMsg} onChange={e=>setChatMsg(e.target.value)} style={{marginBottom:0, flex:1}} placeholder="..."/>
                                        <button onClick={sendChat} style={{width:'auto', margin:'0 0 0 5px', padding:'0 15px'}}>‚û§</button>
                                    </div>
                                </div>
                            )}
                        </>
                    )}

                    {view === 'lobby' && (
                        <div className="card">
                            <h1>Parejas Pro ‚ù§Ô∏è</h1>
                            <input value={playerName} onChange={e=>setPlayerName(e.target.value)} placeholder="Tu Nombre" />
                            <button onClick={createRoom}>Crear Sala</button>
                            <input id="c" placeholder="C√ìDIGO" style={{textTransform:'uppercase', marginTop:20}}/>
                            <button style={{background:'#8b5cf6'}} onClick={()=>joinRoom(document.getElementById('c').value.toUpperCase())}>Unirse</button>
                        </div>
                    )}

                    {view === 'waiting' && <div className="card"><h2>{roomId}</h2><p className="waiting-pulse">Esperando...</p></div>}

                    {view === 'game' && roomData && <ColorGame roomId={roomId} playerRole={playerRole} roomData={roomData} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
