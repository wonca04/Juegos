<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juego Parejas (Debug)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        body { font-family: sans-serif; background: #fdf2f8; color: #831843; padding: 20px; text-align: center; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #fbcfe8; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #db2777; color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; }
        .error { color: red; font-weight: bold; margin-top: 10px; border: 1px solid red; padding: 5px; background: #fee2e2; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // TUS CLAVES
        const firebaseConfig = {
          apiKey: "AIzaSyCbKOu5vwGbowuI5CfbygKJtYujAKa6zJ0",
          authDomain: "juegos-tiktok.firebaseapp.com",
          databaseURL: "https://juegos-tiktok-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "juegos-tiktok",
          storageBucket: "juegos-tiktok.firebasestorage.app",
          messagingSenderId: "504168913042",
          appId: "1:504168913042:web:e9eba88e01f94bcc7a2e4b"
        };

        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        } catch(e) {
            alert("Error iniciando Firebase: " + e.message);
        }
        const db = firebase.database();

        function App() {
            const [view, setView] = React.useState('lobby'); 
            const [playerName, setPlayerName] = React.useState(localStorage.getItem('name') || '');
            const [roomId, setRoomId] = React.useState('');
            const [errorMsg, setErrorMsg] = React.useState('');
            const [roomData, setRoomData] = React.useState(null);

            React.useEffect(() => { localStorage.setItem('name', playerName); }, [playerName]);

            // Escuchar Sala
            React.useEffect(() => {
                if (roomId) {
                    const roomRef = db.ref('salas/' + roomId);
                    roomRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setRoomData(data);
                            if (view === 'waiting' && data.players.guest) setView('game');
                        }
                    }, (error) => {
                        alert("Error de conexiÃ³n: " + error.message);
                    });
                    return () => roomRef.off();
                }
            }, [roomId, view]);

            const createRoom = () => {
                setErrorMsg("");
                if (!playerName) return setErrorMsg("Â¡Pon tu nombre!");
                
                const newId = Math.random().toString(36).substring(2, 6).toUpperCase();
                
                // Intentar guardar en Firebase con reporte de errores
                db.ref('salas/' + newId).set({
                    players: { host: { name: playerName } },
                    gameState: 'LOBBY'
                })
                .then(() => {
                    setRoomId(newId);
                    setView('waiting');
                })
                .catch((error) => {
                    alert("ERROR AL CREAR: " + error.message + "\n\nÂ¿Has puesto las reglas en 'true'?");
                    setErrorMsg(error.message);
                });
            };

            const joinRoom = () => {
                setErrorMsg("");
                const codeInput = document.getElementById('code').value.toUpperCase().trim();
                if (!playerName) return setErrorMsg("Â¡Pon tu nombre!");
                if (!codeInput) return setErrorMsg("Falta el cÃ³digo");

                db.ref('salas/' + codeInput).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                         db.ref('salas/' + codeInput + '/players/guest').set({ name: playerName })
                         .then(() => {
                             setRoomId(codeInput);
                             setView('game');
                         })
                         .catch(e => alert("Error al unirse: " + e.message));
                    } else {
                        alert("Â¡Esa sala no existe! Revisa el cÃ³digo.");
                    }
                })
                .catch((error) => {
                    alert("Error buscando sala: " + error.message);
                });
            };

            return (
                <div className="card">
                    <h1>DiagnÃ³stico ðŸ”§</h1>
                    
                    {errorMsg && <div className="error">{errorMsg}</div>}

                    {view === 'lobby' && (
                        <>
                            <input placeholder="Tu Nombre" value={playerName} onChange={e => setPlayerName(e.target.value)} />
                            <button onClick={createRoom}>1. Crear Sala</button>
                            <hr/>
                            <input id="code" placeholder="CÃ“DIGO (Ej: A1B2)" />
                            <button onClick={joinRoom} style={{background:'#8b5cf6'}}>2. Unirse</button>
                        </>
                    )}

                    {view === 'waiting' && (
                        <>
                            <h2>CÃ³digo: {roomId}</h2>
                            <p>Esperando a que entre el otro...</p>
                            <p style={{fontSize:12}}>Si el otro entra y esto no cambia, recarga la pÃ¡gina.</p>
                        </>
                    )}

                    {view === 'game' && (
                        <>
                            <h2 style={{color:'green'}}>Â¡CONECTADOS! âœ…</h2>
                            <p>Host: {roomData?.players?.host?.name}</p>
                            <p>Guest: {roomData?.players?.guest?.name}</p>
                        </>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
