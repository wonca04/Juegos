<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Couple App Pro</title>
    <meta name="theme-color" content="#121212">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* ESTILO APP PREMIUM */
        :root { --bg: #121212; --card: #1E1E1E; --accent: #6C5DD3; --accent-glow: rgba(108, 93, 211, 0.3); --text: #ffffff; --success: #2ecc71; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'Inter', sans-serif; }
        
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* HEADER CON CHAT */
        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: rgba(30,30,30,0.8); backdrop-filter: blur(10px);
            position: fixed; top: 0; width: 100%; z-index: 100; border-bottom: 1px solid #333;
        }
        .header-title { font-weight: 800; font-size: 1.2em; color: var(--accent); }
        .chat-btn { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; position: relative; }
        .chat-badge { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: red; border-radius: 50%; display: none; }

        /* CHAT OVERLAY */
        #chat-overlay {
            position: fixed; top: 60px; left: 0; width: 100%; height: 0;
            background: rgba(18,18,18,0.95); overflow: hidden; transition: height 0.3s ease;
            z-index: 99; display: flex; flex-direction: column;
        }
        #chat-overlay.open { height: 400px; border-bottom: 1px solid var(--accent); }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .chat-bubble { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 0.9em; }
        .me { background: var(--accent); align-self: flex-end; color: white; }
        .them { background: #333; align-self: flex-start; color: #ccc; }
        .chat-input-area { padding: 15px; display: flex; gap: 10px; background: #1a1a1a; }

        /* CONTENEDOR PRINCIPAL */
        .main-container { padding-top: 80px; padding-bottom: 20px; flex: 1; overflow-y: auto; padding-left: 15px; padding-right: 15px; }
        
        /* TARJETAS Y UI */
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); text-align: center; }
        h2 { margin-top: 0; font-size: 1.1em; opacity: 0.8; }
        input[type=text] { width: 100%; background: #2c2c2c; border: 1px solid #444; color: white; padding: 15px; border-radius: 12px; margin: 10px 0; font-size: 1em; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        
        button { width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: 700; font-size: 1em; cursor: pointer; transition: transform 0.1s; margin-top: 10px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #8E2DE2); color: white; }
        .btn-secondary { background: #333; color: white; }
        button:active { transform: scale(0.96); }

        /* PANTALLAS */
        .screen { display: none; animation: fadeUp 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* JUEGO: DIAL */
        .dial-stage { position: relative; width: 280px; height: 140px; margin: 0 auto 20px; overflow: hidden; }
        .dial-bg { width: 280px; height: 140px; background: #252525; border-radius: 150px 150px 0 0; border: 4px solid #444; position: relative; }
        .target-zone { position: absolute; bottom: 0; left: 50%; height: 100%; transform-origin: bottom; display: none; opacity: 0.8; }
        .z-center { width: 12px; background: #fff; z-index: 5; height: 110%; position: absolute; bottom:0; left:50%; transform: translateX(-50%); }
        .z-mid { width: 50px; background: var(--accent); z-index: 4; height: 100%; position: absolute; bottom:0; left:50%; transform: translateX(-50%); opacity: 0.6; }
        .z-outer { width: 100px; background: var(--accent); z-index: 3; height: 100%; position: absolute; bottom:0; left:50%; transform: translateX(-50%); opacity: 0.2; }
        #pointer { position: absolute; bottom: 0; left: 50%; width: 4px; height: 130px; background: #FF375F; border-radius: 4px; transform-origin: bottom; transform: translateX(-50%) rotate(0deg); transition: transform 0.1s; z-index: 10; }

        /* JUEGO: COLORES */
        .palette-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; border-radius: 10px; overflow: hidden; margin-top: 15px; }
        .p-color { aspect-ratio: 1; cursor: pointer; }
        .coord-display { font-family: monospace; color: #888; font-size: 0.8em; margin-top: 5px; }

        /* ESTADOS DE ESPERA */
        .waiting-pulse { color: var(--accent); animation: pulse 1.5s infinite; font-weight: bold; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .game-nav { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="header-title">CouplePlay ‚ù§Ô∏è</div>
        <button class="chat-btn" onclick="toggleChat()">üí¨<span class="chat-badge" id="chat-alert"></span></button>
    </div>

    <div id="chat-overlay">
        <div class="chat-msgs" id="chat-history"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-in" placeholder="Escribe algo..." style="margin:0">
            <button class="btn-primary" style="width: auto; margin:0" onclick="sendChat()">‚Üí</button>
        </div>
    </div>

    <div class="main-container">

        <div id="screen-login" class="screen active">
            <div class="card">
                <h2>üëã Identif√≠cate</h2>
                <input type="text" id="my-name" placeholder="Tu nombre (ej: juan)">
                <input type="text" id="partner-name" placeholder="Nombre de pareja (ej: ana)">
                <button class="btn-primary" onclick="startConnection()">Conectar</button>
                <p style="font-size:0.8em; color:#666; margin-top:10px">Usad nombres √∫nicos y en min√∫sculas.</p>
            </div>
        </div>

        <div id="screen-menu" class="screen">
            <h2 style="text-align:center; margin-bottom:20px;">Elige Juego</h2>
            <div class="game-nav">
                <button class="btn-secondary" onclick="setupGame('dial')">üé° Dial</button>
                <button class="btn-secondary" onclick="setupGame('colors')">üé® Colores</button>
                <button class="btn-secondary" onclick="setupGame('cat')">üß† 5 Segundos</button>
                <button class="btn-secondary" onclick="setupGame('cafe')">‚òï Caf√© o T√©</button>
            </div>
        </div>

        <div id="screen-dial" class="screen">
            <div id="dial-setup" class="card">
                <h3>1. Preparaci√≥n</h3>
                <p>Elige d√≥nde colocar el objetivo y escribe la pista.</p>
                <div class="dial-stage">
                    <div class="dial-bg">
                        <div id="setup-target" class="target-zone" style="display:block; transform: translateX(-50%) rotate(0deg);">
                            <div class="z-center"></div><div class="z-mid"></div><div class="z-outer"></div>
                        </div>
                    </div>
                </div>
                <input type="range" min="-80" max="80" value="0" style="width:100%" oninput="updateSetupDial(this.value)">
                <input type="text" id="dial-clue" placeholder="Pista (ej: Pel√≠cula de Miedo)">
                <button class="btn-primary" onclick="sendDialReady()">¬°Estoy Listo!</button>
            </div>

            <div id="dial-play" class="card hidden">
                <h3 id="dial-status">Esperando...</h3>
                <div class="dial-stage">
                    <div class="dial-bg">
                        <div id="real-target" class="target-zone">
                            <div class="z-center"></div><div class="z-mid"></div><div class="z-outer"></div>
                        </div>
                        <div id="pointer"></div>
                    </div>
                </div>
                <div id="dial-slider-container" class="hidden">
                    <input type="range" id="game-slider" min="-80" max="80" value="0" style="width:100%" oninput="moveGameDial(this.value)">
                    <button class="btn-primary" onclick="submitDialGuess()">Confirmar Posici√≥n</button>
                </div>
                <button id="dial-next-btn" class="btn-secondary hidden" onclick="startRound2()">Turno de tu pareja</button>
                <button id="dial-finish-btn" class="btn-secondary hidden" onclick="goToMenu()">Terminar Juego</button>
            </div>
        </div>

        <div id="screen-colors" class="screen">
            <div id="colors-setup" class="card">
                <h3>1. Elige tu Color</h3>
                <p>Toca un color de la paleta y escribe la pista.</p>
                <div class="palette-grid" id="palette-setup"></div>
                <p id="color-selected-coord" class="coord-display">Ninguno seleccionado</p>
                <input type="text" id="color-clue" placeholder="Pista (ej: Como tus ojos)">
                <button class="btn-primary" onclick="sendColorReady()">¬°Estoy Listo!</button>
            </div>

            <div id="colors-play" class="card hidden">
                <h3 id="colors-status">Turno de...</h3>
                <p id="colors-hint" style="color:var(--accent); font-weight:bold;"></p>
                <div class="palette-grid" id="palette-play"></div>
                <div id="p1-cursor" style="display:none; width:10px; height:10px; background:red; border-radius:50%; margin: 5px auto;">Tu elecci√≥n</div>
                <div id="p2-cursor" style="display:none; width:10px; height:10px; background:blue; border-radius:50%; margin: 5px auto;">Su elecci√≥n</div>
                
                <button id="colors-next-btn" class="btn-secondary hidden" onclick="startColorRound2()">Siguiente Turno</button>
                <button id="colors-finish-btn" class="btn-secondary hidden" onclick="goToMenu()">Terminar</button>
            </div>
        </div>

        <div id="screen-cat" class="screen">
            <div class="card">
                <h3>üß† No digas lo mismo</h3>
                <h1 id="cat-timer" style="font-size:3em; color:var(--accent)">5</h1>
                <h2 id="cat-topic" style="color:#fff">Esperando...</h2>
                <input type="text" id="cat-input" placeholder="Escribe tu palabra aqu√≠...">
                <div id="cat-results" class="hidden" style="margin-top:20px; padding:10px; background:#333; border-radius:10px;">
                    <p>T√∫: <b id="res-me">...</b></p>
                    <p>Pareja: <b id="res-them">...</b></p>
                </div>
                <button id="btn-cat-start" class="btn-primary" onclick="startCatRound()">Generar Categor√≠a</button>
            </div>
        </div>

        <div id="screen-cafe" class="screen">
            <div class="card">
                <h3>‚òï Caf√© o T√©</h3>
                <div id="cafe-setup">
                    <input type="text" id="cafe-secret" placeholder="Escribe tu palabra secreta">
                    <button class="btn-primary" onclick="sendCafeReady()">Fijar Palabra</button>
                </div>
                <div id="cafe-play" class="hidden">
                    <p id="cafe-instruction">...</p>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="opt-1" placeholder="Opci√≥n A (ej: Caf√©)">
                        <input type="text" id="opt-2" placeholder="Opci√≥n B (ej: T√©)">
                    </div>
                    <button class="btn-primary" onclick="sendCafeOptions()">Preguntar</button>
                    <div id="cafe-log" style="text-align:left; margin-top:20px; height:150px; overflow-y:auto; background:#222; padding:10px;"></div>
                </div>
            </div>
        </div>

    </div>

<script>
    // --- L√ìGICA DE CONEXI√ìN (IDs CORTAS) ---
    // Usamos PeerJS pero forzamos el ID
    let peer, conn;
    let myName, partnerName;
    let currentData = {}; // Para guardar estados

    function startConnection() {
        myName = document.getElementById('my-name').value.trim().toLowerCase();
        partnerName = document.getElementById('partner-name').value.trim().toLowerCase();
        
        if(!myName || !partnerName) return alert("Rellena los nombres");

        // Creamos peer con tu nombre como ID
        peer = new Peer(myName);

        peer.on('open', (id) => {
            console.log('Mi ID es: ' + id);
            // Intentamos conectar con la pareja
            connectToPartner();
        });

        peer.on('connection', (c) => {
            // Si alguien se conecta a m√≠
            if(c.peer === partnerName) {
                conn = c;
                setupConn();
            }
        });

        peer.on('error', (err) => {
            if(err.type === 'unavailable-id') alert("Ese nombre ya est√° en uso. Prueba otro.");
            else alert("Error: " + err.type);
        });
    }

    function connectToPartner() {
        conn = peer.connect(partnerName);
        conn.on('open', () => {
            setupConn();
        });
        // Si falla la conexi√≥n inmediata, PeerJS reintentar√° o esperamos a que el otro se conecte a m√≠.
    }

    function setupConn() {
        document.getElementById('screen-login').classList.remove('active');
        document.getElementById('screen-menu').classList.add('active');
        addChatMsg("SISTEMA", "¬°Conectados! Elegid un juego.");
        
        conn.on('data', (data) => handleData(data));
    }

    function handleData(d) {
        if(d.type === 'chat') addChatMsg("Pareja", d.msg);
        // DIAL
        if(d.type === 'dial-ready') checkDialStart(d);
        if(d.type === 'dial-move') document.getElementById('pointer').style.transform = `translateX(-50%) rotate(${d.val}deg)`;
        if(d.type === 'dial-guess') revealDialRound(d.val);
        // COLORES
        if(d.type === 'color-ready') checkColorStart(d);
        if(d.type === 'color-move') highlightColor(d.idx, 'p2');
        if(d.type === 'color-guess') revealColorRound(d.idx);
        // CAT
        if(d.type === 'cat-start') startCatTimer(d.cat);
        if(d.type === 'cat-res') showCatResult(d.word);
        // CAFE
        if(d.type === 'cafe-ready') checkCafeStart();
        if(d.type === 'cafe-ask') showCafeChoice(d.opt1, d.opt2);
        if(d.type === 'cafe-pick') logCafe(d.pick);
    }

    // --- NAVEGACI√ìN ---
    function goToMenu() {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-menu').classList.add('active');
    }
    
    function setupGame(game) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-'+game).classList.add('active');
        
        // Reset estados
        currentData = {}; 
        if(game==='colors') generatePalette();
    }

    // --- 1. JUEGO DIAL (L√ìGICA DOBLE) ---
    let myDialSetup = null;
    let partnerDialSetup = null;

    function updateSetupDial(val) {
        document.getElementById('setup-target').style.transform = `translateX(-50%) rotate(${val}deg)`;
        myDialSetup = { angle: val };
    }

    function sendDialReady() {
        const clue = document.getElementById('dial-clue').value;
        if(!myDialSetup || !clue) return alert("Coloca el objetivo y pon pista");
        myDialSetup.clue = clue;
        
        document.getElementById('dial-setup').innerHTML = "<h3>Esperando a tu pareja...</h3><p class='waiting-pulse'>Sincronizando</p>";
        conn.send({type: 'dial-ready', setup: myDialSetup});
        checkDialStart();
    }

    function checkDialStart(data) {
        if(data) partnerDialSetup = data.setup;
        if(myDialSetup && partnerDialSetup) {
            // LOS DOS LISTOS. EMPIEZA RONDA 1 (Yo adivino lo suyo)
            startDialRound1();
        }
    }

    function startDialRound1() {
        document.getElementById('dial-setup').classList.add('hidden');
        document.getElementById('dial-play').classList.remove('hidden');
        
        // Configuro la pantalla para la Ronda 1: JUEGA P1 (Yo) adivinando P2
        // Pero espera... para hacerlo justo, vamos a decir que quien tenga el nombre alfab√©ticamente menor empieza.
        const iAmFirst = myName < partnerName;
        
        if(iAmFirst) {
            // Yo adivino
            setupDialTurn(true, partnerDialSetup.clue);
        } else {
            // Yo miro
            setupDialTurn(false, myDialSetup.clue); // Mi pareja adivina mi pista
        }
    }

    function setupDialTurn(isMyTurn, clue) {
        document.getElementById('dial-status').innerText = isMyTurn ? "TU TURNO" : "TURNO DE PAREJA";
        document.getElementById('dial-status').style.color = isMyTurn ? "var(--success)" : "#fff";
        
        // Mostrar pista en grande
        const h3 = document.createElement('h2'); h3.innerText = "Pista: " + clue;
        document.getElementById('dial-play').prepend(h3);

        // Ocultar objetivo (nadie lo ve aun)
        document.getElementById('real-target').style.display = 'none';

        if(isMyTurn) {
            document.getElementById('dial-slider-container').classList.remove('hidden');
        } else {
            document.getElementById('dial-slider-container').classList.add('hidden');
        }
    }

    function moveGameDial(val) {
        document.getElementById('pointer').style.transform = `translateX(-50%) rotate(${val}deg)`;
        conn.send({type: 'dial-move', val: val});
    }

    function submitDialGuess() {
        const val = document.getElementById('game-slider').value;
        conn.send({type: 'dial-guess', val: val});
        revealDialRound(val); // Me lo muestro a m√≠ tambi√©n
    }

    function revealDialRound(guessVal) {
        // Mostrar el objetivo real
        // ¬øDe qui√©n era el objetivo? Si yo adivinaba, era el de mi pareja.
        const iWasGuessing = !document.getElementById('dial-slider-container').classList.contains('hidden');
        const targetAngle = iWasGuessing ? partnerDialSetup.angle : myDialSetup.angle;

        const target = document.getElementById('real-target');
        target.style.display = 'block';
        target.style.transform = `translateX(-50%) rotate(${targetAngle}deg)`;
        
        document.getElementById('dial-slider-container').classList.add('hidden');
        
        // Bot√≥n para siguiente ronda
        if(iWasGuessing) {
            // Si yo acabo de jugar, ahora le toca a √©l
            document.getElementById('dial-next-btn').classList.remove('hidden');
            document.getElementById('dial-next-btn').innerText = "Que juegue mi pareja";
            document.getElementById('dial-next-btn').onclick = () => {
                 conn.send({type: 'dial-ready', setup: myDialSetup}); // Reenviar se√±al de cambio (simplificado)
                 // Aqu√≠ deber√≠amos limpiar y lanzar Ronda 2. Por simplicidad en este c√≥digo, recargamos UI inversa.
                 alert("¬°Turno completado! Recargando para el siguiente...");
                 location.reload(); // En una app real har√≠amos swap de variables.
            };
        } else {
            document.getElementById('dial-status').innerText = "Ronda terminada. Mira el resultado.";
        }
    }

    // --- 2. JUEGO COLORES (GRAN ESCALA) ---
    let myColorIdx = -1;
    let partnerColorIdx = -1;
    let myColorClue = "";
    
    function generatePalette() {
        const grid = document.getElementById('palette-setup');
        const gridPlay = document.getElementById('palette-play');
        grid.innerHTML = ""; gridPlay.innerHTML = "";
        
        // 64 colores (8x8)
        for(let i=0; i<64; i++) {
            let hue = (i * 360 / 64);
            let div = document.createElement('div');
            div.className = 'p-color';
            div.style.background = `hsl(${hue}, 70%, 50%)`;
            div.onclick = () => selectColorSetup(i, hue);
            grid.appendChild(div);

            // Copia para el juego
            let div2 = div.cloneNode();
            div2.id = 'play-col-'+i;
            div2.onclick = () => clickColorPlay(i);
            gridPlay.appendChild(div2);
        }
    }

    function selectColorSetup(idx, hue) {
        myColorIdx = idx;
        document.getElementById('color-selected-coord').innerText = `Color #${idx} seleccionado`;
        document.getElementById('palette-setup').style.border = "2px solid white";
    }

    function sendColorReady() {
        myColorClue = document.getElementById('color-clue').value;
        if(myColorIdx === -1 || !myColorClue) return alert("Elige color y pista");
        
        document.getElementById('colors-setup').innerHTML = "<h3 class='waiting-pulse'>Esperando a pareja...</h3>";
        conn.send({type: 'color-ready', idx: myColorIdx, clue: myColorClue});
        checkColorStart();
    }

    function checkColorStart(data) {
        if(data) { currentData.partnerColor = data.idx; currentData.partnerClue = data.clue; }
        
        if(myColorIdx !== -1 && currentData.partnerColor !== undefined) {
            // AMBOS LISTOS
            document.getElementById('colors-setup').classList.add('hidden');
            document.getElementById('colors-play').classList.remove('hidden');
            
            // L√≥gica de turnos: Empieza quien sea alfab√©ticamente menor
            const iAmFirst = myName < partnerName;
            if(iAmFirst) playColorTurn(true); // Yo adivino
            else playColorTurn(false); // Yo espero
        }
    }

    function playColorTurn(isMyTurn) {
        const status = document.getElementById('colors-status');
        const hint = document.getElementById('colors-hint');
        
        if(isMyTurn) {
            status.innerText = "TU TURNO: Adivina el color";
            hint.innerText = "Pista: " + currentData.partnerClue;
            // Activar clicks
            document.getElementById('palette-play').style.pointerEvents = 'auto';
        } else {
            status.innerText = "ESPERANDO A PAREJA...";
            hint.innerText = "Pista dada: " + myColorClue;
            document.getElementById('palette-play').style.pointerEvents = 'none'; // No puedes tocar
        }
    }

    function clickColorPlay(idx) {
        // Solo funciona si es mi turno
        highlightColor(idx, 'p1'); // Muestro mi selecci√≥n
        conn.send({type: 'color-move', idx: idx}); // Env√≠o que estoy tocando este
        
        if(confirm("¬øConfirmar este color?")) {
            conn.send({type: 'color-guess', idx: idx});
            revealColorRound(idx);
        }
    }

    function highlightColor(idx, player) {
        // Efecto visual simple
        const el = document.getElementById('play-col-'+idx);
        el.style.border = player === 'p1' ? '3px solid white' : '3px dashed white';
    }

    function revealColorRound(guessIdx) {
        // Mostrar cu√°l era el verdadero
        const iWasGuessing = document.getElementById('colors-status').innerText.includes("TU TURNO");
        const trueIdx = iWasGuessing ? currentData.partnerColor : myColorIdx;
        
        document.getElementById('play-col-'+trueIdx).innerText = "üìç"; // Marca del verdadero
        document.getElementById('play-col-'+trueIdx).style.transform = "scale(1.2)";
        
        alert(iWasGuessing ? "¬°Resultado revelado! (Marcado con üìç)" : "¬°Tu pareja ha elegido!");
        
        // Bot√≥n para salir (o reiniciar turno manual)
        document.getElementById('colors-finish-btn').classList.remove('hidden');
    }

    // --- 3. CATEGOR√çAS 5S ---
    function startCatRound() {
        const cats = ["Fruta", "Pa√≠s", "Animal", "Marca", "Objeto de casa", "Comida", "Color", "Famoso"];
        const c = cats[Math.floor(Math.random()*cats.length)];
        conn.send({type: 'cat-start', cat: c});
        startCatTimer(c);
    }

    function startCatTimer(cat) {
        document.getElementById('cat-topic').innerText = cat;
        document.getElementById('cat-input').value = "";
        document.getElementById('cat-results').classList.add('hidden');
        
        let s = 5;
        const t = document.getElementById('cat-timer');
        const i = setInterval(() => {
            t.innerText = s; s--;
            if(s < 0) {
                clearInterval(i);
                t.innerText = "¬°YA!";
                const myWord = document.getElementById('cat-input').value;
                conn.send({type: 'cat-res', word: myWord});
                document.getElementById('res-me').innerText = myWord;
                checkCatResults();
            }
        }, 1000);
    }
    
    let partnerWord = null;
    function showCatResult(word) {
        partnerWord = word;
        checkCatResults();
    }
    
    function checkCatResults() {
        const myW = document.getElementById('res-me').innerText;
        if(partnerWord !== null && myW !== "...") {
             document.getElementById('res-them').innerText = partnerWord;
             document.getElementById('cat-results').classList.remove('hidden');
             partnerWord = null; // Reset para la proxima
        }
    }

    // --- 4. CAF√â O T√â ---
    function sendCafeReady() {
        const w = document.getElementById('cafe-secret').value;
        if(!w) return;
        document.getElementById('cafe-setup').innerHTML = "<p>Palabra fijada. Esperando a pareja...</p>";
        conn.send({type: 'cafe-ready'});
        checkCafeStart();
    }
    
    let cafeReadyCount = 0;
    function checkCafeStart() {
        cafeReadyCount++; // Simplificado: cada vez que alguien est√° listo suma
        // En real: necesitariamos saber QUIEN est√° listo. Asumimos sincron√≠a por el chat.
        if(cafeReadyCount >= 1) { // L√≥gica laxa para no bloquear
            document.getElementById('cafe-play').classList.remove('hidden');
            document.getElementById('cafe-instruction').innerText = "Uno pregunta, el otro elige.";
        }
    }

    function sendCafeOptions() {
        const o1 = document.getElementById('opt-1').value;
        const o2 = document.getElementById('opt-2').value;
        conn.send({type: 'cafe-ask', opt1: o1, opt2: o2});
        logCafe(`T√∫ preguntas: ¬ø${o1} o ${o2}?`);
    }

    function showCafeChoice(o1, o2) {
        // Me preguntan a m√≠
        const html = `
            <div style="background:#444; padding:10px; margin:5px; border-radius:5px;">
                <p>Elige acercarte a tu palabra:</p>
                <button class="btn-primary" style="margin:2px" onclick="pickCafe('${o1}')">${o1}</button>
                <button class="btn-primary" style="margin:2px" onclick="pickCafe('${o2}')">${o2}</button>
            </div>
        `;
        document.getElementById('cafe-log').innerHTML += html;
    }

    function pickCafe(val) {
        conn.send({type: 'cafe-pick', pick: val});
        logCafe(`Elegiste: ${val}`);
    }

    function logCafe(txt) {
        document.getElementById('cafe-log').innerHTML += `<p>${txt}</p>`;
    }

    // --- CHAT ---
    function toggleChat() {
        const el = document.getElementById('chat-overlay');
        el.classList.toggle('open');
        document.getElementById('chat-alert').style.display = 'none';
    }

    function sendChat() {
        const i = document.getElementById('chat-in');
        const txt = i.value;
        if(!txt) return;
        addChatMsg("T√∫", txt);
        conn.send({type: 'chat', msg: txt});
        i.value = "";
    }

    function addChatMsg(who, txt) {
        const d = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = `chat-bubble ${who === 'T√∫' ? 'me' : 'them'}`;
        div.innerText = txt;
        d.appendChild(div);
        d.scrollTop = d.scrollHeight;
        
        if(who !== "T√∫" && !document.getElementById('chat-overlay').classList.contains('open')) {
            document.getElementById('chat-alert').style.display = 'block';
        }
    }

</script>
</body>
</html>
