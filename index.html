<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juegos Parejas Ultimate (Versi√≥n Final)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* ESTILOS GENERALES (TEMA OSCURO) */
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #fce7f3; margin: 0; padding: 10px; text-align: center; }
        
        .card { background: #1e1e1e; padding: 15px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); max-width: 600px; margin: 10px auto; border: 1px solid #333; position: relative; z-index: 1; }
        
        button { width: 100%; padding: 14px; background: #be185d; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 15px; transition: 0.2s; cursor: pointer; }
        button:disabled { background: #444; color: #888; opacity: 0.5; }
        button:active { transform: scale(0.98); }
        
        input { width: 100%; padding: 12px; background: #333; border: 2px solid #555; border-radius: 10px; color: white; text-align: center; font-size: 16px; outline: none; margin-bottom: 10px; }
        input:focus { border-color: #be185d; }

        /* MENU SELECCI√ìN */
        .game-btn { padding: 20px; font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; border: 2px solid transparent; }
        .btn-colors { background: linear-gradient(45deg, #ef4444, #eab308, #3b82f6); }
        .btn-dial { background: linear-gradient(45deg, #4f46e5, #818cf8); }
        .btn-cats { background: linear-gradient(45deg, #10b981, #34d399); color: #064e3b; }
        .btn-mind { background: linear-gradient(45deg, #d946ef, #8b5cf6); }

        /* ESTILOS COMUNES */
        .waiting-pulse { color: #888; font-style: italic; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .score-big { font-size: 60px; font-weight: 900; margin: 10px 0; text-shadow: 0 4px 10px black; animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* JUEGO CONVERGENCIA (CAF√â O T√â) */
        .secret-box { background: #4c1d95; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed #a78bfa; font-size: 14px; color: #ddd; }
        .vs-container { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin: 20px 0; }
        .option-btn { background: #333; border: 2px solid #555; padding: 20px 5px; flex: 1; font-size: 18px; color: white; border-radius: 12px; height: 100px; display: flex; align-items: center; justify-content: center; word-break: break-word; }
        .option-btn:active { transform: scale(0.95); border-color: #d946ef; }
        .current-winner { font-size: 24px; font-weight: bold; color: #fbbf24; margin: 10px 0; padding: 10px; border: 2px solid #fbbf24; border-radius: 10px; display: inline-block; }

        /* JUEGO CATEGOR√çAS */
        .cat-display { font-size: 22px; font-weight: bold; color: #34d399; margin: 10px 0; padding: 15px; border: 2px dashed #34d399; border-radius: 15px; background: #064e3b; }
        .timer-circle { width: 80px; height: 80px; border-radius: 50%; background: #333; margin: 10px auto; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: 900; color: white; border: 4px solid #34d399; }
        .timer-danger { border-color: #ef4444; color: #ef4444; animation: pulse 0.2s infinite; }
        .word-reveal { font-size: 24px; font-weight: bold; margin: 10px 0; padding: 10px; background: #333; border-radius: 10px; }
        
        /* DIAL Styles */
        .dial-main-container { position: relative; width: 300px; height: 160px; margin: 20px auto; }
        .dial-mask { width: 300px; height: 150px; overflow: hidden; border-top-left-radius: 150px; border-top-right-radius: 150px; position: absolute; top: 0; left: 0; background: #374151; border-bottom: 2px solid #555; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); z-index: 1; }
        .target-wedge-wrapper { position: absolute; bottom: 0; left: 50%; width: 0; height: 0; z-index: 2; transition: opacity 0.3s ease; }
        .target-wedge-graphic { width: 300px; height: 300px; border-radius: 50%; position: absolute; top: -150px; left: -150px; background: conic-gradient(from -28deg at 50% 50%, #facc15 0deg, #facc15 10deg, #f97316 10deg, #f97316 20deg, #be185d 20deg, #be185d 36deg, #f97316 36deg, #f97316 46deg, #facc15 46deg, #facc15 56deg, transparent 56deg); }
        .needle-container { position: absolute; bottom: 10px; left: 50%; width: 0; height: 0; z-index: 10; }
        .needle { width: 4px; height: 140px; background: #ef4444; position: absolute; bottom: 0; left: -2px; transform-origin: bottom center; border-radius: 2px; box-shadow: 0 0 5px rgba(255,0,0,0.8); transition: transform 0.1s cubic-bezier(0,0,0.2,1); }
        .knob { width: 24px; height: 24px; background: #e5e7eb; border-radius: 50%; position: absolute; bottom: 0; left: 50%; transform: translate(-50%, 50%); z-index: 20; border: 2px solid #ef4444; box-shadow: 0 2px 5px black; }
        .topic-card { background: #312e81; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #6366f1; margin-bottom: 20px; font-size: 14px; font-weight: bold; }

        /* COLORES Styles */
        .grid-wrapper { overflow-x: auto; padding-bottom: 10px; display: flex; justify-content: center; }
        .color-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 1px; background: #000; padding: 2px; border-radius: 6px; min-width: 340px; }
        .color-cell { aspect-ratio: 1; border-radius: 1px; cursor: pointer; position: relative; }
        .coord-box { background: #be185d; padding: 2px 8px; border-radius: 4px; font-weight: bold; display: inline-block; font-size: 18px; margin-bottom: 5px; }
        .target-star::after { content: "‚òÖ"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 8px; pointer-events: none; text-shadow: 0 0 2px black; }
        .guess-mark-current { box-shadow: 0 0 0 2px white, 0 0 8px #be185d; z-index: 10; transform: scale(1.2); }
        .hint-display { background: #333; padding: 8px; border-radius: 6px; font-style: italic; border-left: 3px solid #be185d; text-align: left; margin: 5px 0; font-size: 14px; }
        
        /* CHAT */
        .chat-btn { position: fixed; top: 15px; right: 15px; width: 45px; height: 45px; background: #be185d; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 9999; border: 2px solid white; box-shadow: 0 4px 10px black; cursor: pointer; font-size: 20px; }
        .chat-overlay { position: fixed; bottom: 0; left: 0; right: 0; height: 50vh; background: #222; border-top: 2px solid #be185d; z-index: 9998; display: flex; flex-direction: column; box-shadow: 0 -10px 50px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyCbKOu5vwGbowuI5CfbygKJtYujAKa6zJ0",
          authDomain: "juegos-tiktok.firebaseapp.com",
          databaseURL: "https://juegos-tiktok-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "juegos-tiktok",
          storageBucket: "juegos-tiktok.firebasestorage.app",
          messagingSenderId: "504168913042",
          appId: "1:504168913042:web:e9eba88e01f94bcc7a2e4b"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // DATOS
        const DIAL_TOPICS = [
            ["Fr√≠o", "Caliente"], ["Feo", "Guapo"], ["Barato", "Caro"], ["In√∫til", "√ötil"], ["Aburrido", "Divertido"], ["Seco", "Mojado"], ["F√°cil", "Dif√≠cil"], ["Odiado", "Amado"],
            ["Basura", "Tesoro"], ["Blando", "Duro"], ["Sano", "Insalubre"], ["Legal", "Ilegal"], ["Poco √©tico", "√âtico"], ["Placer", "Dolor"], ["Cierto", "Falso"], ["Normal", "Raro"],
            ["Talento", "Habilidad"], ["Ciencia", "Fantas√≠a"], ["Temporal", "Eterno"], ["Local", "Global"], ["Ruidoso", "Silencioso"], ["Picante", "Dulce"], ["Trabajo", "Hobby"],
            ["Peligroso", "Seguro"], ["Oscuro", "Luminoso"], ["Retro", "Moderno"], ["Ni√±o", "Adulto"], ["Limpio", "Sucio"], ["Gato", "Perro"], ["Cerveza", "Vino"], ["Playa", "Monta√±a"],
            ["Carne", "Pescado"], ["Inteligente", "Bello"], ["Ducha", "Ba√±o"], ["Pizza", "Hamburguesa"], ["Madrugar", "Trasnochar"], ["Verano", "Invierno"], ["Cine", "Netflix"],
            ["Formal", "Casual"], ["Ordenado", "Ca√≥tico"], ["Ahorrador", "Derrochador"], ["T√≠mido", "Extrovertido"], ["Optimista", "Pesimista"], ["Realista", "So√±ador"], ["Vainilla", "Chocolate"],
            ["Amor", "Dinero"], ["Justicia", "Venganza"], ["Perd√≥n", "Rencor"], ["Hablar", "Escuchar"], ["Mentira", "Verdad"], ["Pasado", "Futuro"], ["Sol", "Luna"]
        ];
        
        const CAT_LIST = [
            "Marcas de Coche", "Frutas", "Cosas Rojas", "Pa√≠ses de Europa", "Marcas de Ropa", "Animales de Granja", "Cosas del ba√±o", "Nombres de mujer", "Deportes", "Helados", 
            "Cosas que se rompen", "Pel√≠culas Disney", "Cosas redondas", "Comida basura", "Cosas que vuelan", "Instrumentos", "Cosas fr√≠as", "Marcas tecnolog√≠a", "Partes del cuerpo", 
            "Cosas de miedo", "Animales marinos", "Bebidas alcoh√≥licas", "Malos olores", "Verbos", "Cosas de madera", "Superh√©roes", "Cosas de bolso", "Programas TV", "Colores", 
            "Bebidas calientes", "Capitales", "Zapatillas", "Cosas pegajosas", "Villanos", "Explosivos", "Emojis", "Apps", "Cosas verdes", "Cereales", "Cosas de playa", "Videojuegos", "Youtubers"
        ];

        // ==========================================
        // JUEGO 4: CONVERGENCIA (L√ìGICA NUEVA)
        // ==========================================
        const MindGame = ({ roomId, playerRole, roomData, onBack }) => {
            const game = roomData.mindGame || {};
            
            // Turnos:
            // "host" = Host pone la palabra secreta.
            // "guest" = Guest pone la palabra secreta.
            // Una vez puesta, la fase pasa a "GUESSING" y se van turnando.
            
            const isMyTurnToSet = (!game.turn && playerRole==='host') || (game.turn===playerRole);
            const isMyTurnToGuess = game.phase === 'GUESSING' && game.guesser === playerRole;
            const isMyTurnToChoose = game.phase === 'CHOOSING' && game.setter === playerRole;

            const initGame = () => {
                const starter = (!game.turn || game.turn === 'guest') ? 'host' : 'guest';
                db.ref(`salas/${roomId}/mindGame`).set({
                    turn: starter,
                    phase: 'SETUP', // SETUP -> GUESSING -> CHOOSING
                    setter: starter, // Quien pens√≥ la palabra
                    guesser: starter === 'host' ? 'guest' : 'host',
                    secretWord: '',
                    currentBase: 'Caf√©', // Palabra inicial por defecto
                    candidateWord: ''
                });
            };

            const setSecret = (word) => {
                if(!word) return;
                db.ref(`salas/${roomId}/mindGame`).update({ 
                    secretWord: word.toUpperCase(), 
                    phase: 'GUESSING' 
                });
            };

            const sendGuess = (word) => {
                if(!word) return;
                db.ref(`salas/${roomId}/mindGame`).update({ 
                    candidateWord: word.toUpperCase(), 
                    phase: 'CHOOSING' 
                });
            };

            const chooseWinner = (choice) => {
                // choice puede ser 'BASE' (mantiene la actual) o 'CANDIDATE' (la nueva)
                const newBase = choice === 'BASE' ? game.currentBase : game.candidateWord;
                db.ref(`salas/${roomId}/mindGame`).update({ 
                    currentBase: newBase, 
                    candidateWord: '', 
                    phase: 'GUESSING' 
                });
            };

            const declareWin = () => {
                db.ref(`salas/${roomId}/mindGame`).update({ phase: 'WIN' });
            };

            if (!game.phase) return <div className="card"><h2>‚òï Caf√© o T√©</h2><p>Ac√©rcate a la palabra secreta.</p><button onClick={initGame} className="game-btn btn-mind">EMPEZAR</button><br/><button onClick={onBack} style={{background:'#555'}}>MEN√ö</button></div>;

            return (
                <div className="card">
                    <button onClick={onBack} style={{float:'right', padding:5, background:'transparent', border:'1px solid #555'}}>SALIR</button>
                    <div style={{clear:'both', color:'#aaa', marginBottom:10}}>RONDA DE: {game.setter === 'host' ? roomData.players.host.name : roomData.players.guest.name}</div>

                    {/* FASE 1: PENSAR PALABRA SECRETA */}
                    {game.phase === 'SETUP' && (
                        <div>
                            {playerRole === game.setter ? (
                                <div>
                                    <p>Piensa una palabra secreta:</p>
                                    <input id="secretIn" placeholder="Ej: Oc√©ano" autoComplete="off" />
                                    <button onClick={()=>setSecret(document.getElementById('secretIn').value)}>FIJAR SECRETO</button>
                                </div>
                            ) : <p className="waiting-pulse">Tu pareja est√° pensando una palabra...</p>}
                        </div>
                    )}

                    {/* JUEGO EN MARCHA */}
                    {(game.phase === 'GUESSING' || game.phase === 'CHOOSING') && (
                        <div>
                            {playerRole === game.setter && (
                                <div className="secret-box">Tu secreto: <b>{game.secretWord}</b></div>
                            )}
                            
                            <div className="current-winner">Palabra actual: {game.currentBase}</div>

                            {/* FASE 2: ADIVINAR (GUESSER) */}
                            {game.phase === 'GUESSING' && (
                                <div>
                                    {playerRole === game.guesser ? (
                                        <div>
                                            <p>Escribe algo que se acerque m√°s:</p>
                                            <input id="guessIn" placeholder="Tu intento..." autoComplete="off" />
                                            <button onClick={()=>sendGuess(document.getElementById('guessIn').value)}>ENVIAR</button>
                                        </div>
                                    ) : <p className="waiting-pulse">Tu pareja est√° pensando una palabra...</p>}
                                </div>
                            )}

                            {/* FASE 3: ELEGIR (SETTER) */}
                            {game.phase === 'CHOOSING' && (
                                <div>
                                    {playerRole === game.setter ? (
                                        <div>
                                            <p>¬øCu√°l est√° m√°s cerca de <b>{game.secretWord}</b>?</p>
                                            <div className="vs-container">
                                                <button className="option-btn" onClick={()=>chooseWinner('BASE')}>{game.currentBase}</button>
                                                <button className="option-btn" onClick={()=>chooseWinner('CANDIDATE')}>{game.candidateWord}</button>
                                            </div>
                                            <div style={{borderTop:'1px solid #555', paddingTop:10}}>
                                                <p style={{fontSize:12, color:'#aaa'}}>¬øHa acertado?</p>
                                                <button onClick={declareWin} style={{background:'#10b981', marginTop:0}}>¬°S√ç, ESA ES!</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <p>Has dicho: <b>{game.candidateWord}</b></p>
                                            <p className="waiting-pulse">Tu pareja est√° eligiendo...</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* VICTORIA */}
                    {game.phase === 'WIN' && (
                        <div>
                            <div style={{fontSize:40, margin:'20px 0'}}>üéâ ¬°ACERTASTE!</div>
                            <p>La palabra era: <b>{game.secretWord}</b></p>
                            <p>√öltima aproximaci√≥n: <b>{game.currentBase}</b></p>
                            <button onClick={initGame}>CAMBIAR ROLES</button>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // JUEGO 3: CATEGOR√çAS (AUTO 5s)
        // ==========================================
        const CategoryGame = ({ roomId, playerRole, roomData, onBack }) => {
            const game = roomData.catGame || {};
            const [timeLeft, setTimeLeft] = React.useState(5);

            React.useEffect(() => {
                let timer = null;
                if (game.phase === 'PLAY') {
                    setTimeLeft(5); 
                    timer = setInterval(() => {
                        setTimeLeft((prev) => {
                            if (prev <= 1) {
                                clearInterval(timer);
                                submitWord(document.getElementById('wordIn')?.value || '');
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timer);
            }, [game.phase]);

            const startRound = () => {
                const cat = CAT_LIST[Math.floor(Math.random() * CAT_LIST.length)];
                db.ref(`salas/${roomId}/catGame`).set({ category: cat, phase: 'PLAY', p1Word: '', p2Word: '', score: game.score || 0 });
            };

            const submitWord = (word) => {
                const field = playerRole === 'host' ? 'p1Word' : 'p2Word';
                db.ref(`salas/${roomId}/catGame`).update({ [field]: word || "..." }); 
            };

            React.useEffect(() => {
                if (game.phase === 'PLAY' && game.p1Word && game.p2Word && playerRole === 'host') {
                    db.ref(`salas/${roomId}/catGame/phase`).set('REVEAL');
                }
            }, [game.p1Word, game.p2Word, game.phase]);

            const vote = (result) => { 
                let newScore = game.score; if (result === 'DIFF') newScore += 1; else newScore = 0; 
                db.ref(`salas/${roomId}/catGame/score`).set(newScore); startRound(); 
            };

            if (!game.category) return <div className="card"><h2>üö´ No Digas lo Mismo</h2><p>5 Segundos para pensar y escribir.</p><button onClick={()=>startRound()} className="game-btn btn-cats">EMPEZAR</button><br/><button onClick={onBack} style={{background:'#555'}}>MEN√ö</button></div>;

            return (
                <div className="card">
                    <button onClick={onBack} style={{float:'right', padding:5, background:'transparent', border:'1px solid #555'}}>SALIR</button>
                    <div style={{clear:'both'}}>RACHA: <span style={{color:'#34d399', fontSize:24, fontWeight:'bold'}}>{game.score}</span></div>
                    <div className="cat-display">{game.category}</div>
                    {game.phase === 'PLAY' && (<div><div className={`timer-circle ${timeLeft <= 2 ? 'timer-danger' : ''}`}>{timeLeft}</div>{(playerRole==='host' && game.p1Word) || (playerRole==='guest' && game.p2Word) ? <p className="waiting-pulse">Enviado. Esperando...</p> : <div><input id="wordIn" placeholder="Escribe aqu√≠..." autoFocus autoComplete="off" /><button onClick={()=>submitWord(document.getElementById('wordIn').value)}>ENVIAR</button></div>}</div>)}
                    {game.phase === 'REVEAL' && (<div><div className="word-reveal" style={{borderLeft:'5px solid #be185d'}}>{roomData.players.host.name}: <br/> <span style={{color:'white'}}>{game.p1Word}</span></div><div className="word-reveal" style={{borderLeft:'5px solid #3b82f6'}}>{roomData.players.guest.name}: <br/> <span style={{color:'white'}}>{game.p2Word}</span></div><p style={{marginTop:20}}>¬øSon distintas?</p>{playerRole === 'host' ? (<div style={{display:'flex', gap:10}}><button onClick={()=>vote('DIFF')} style={{background:'#10b981'}}>‚úÖ S√ç (+1)</button><button onClick={()=>vote('SAME')} style={{background:'#ef4444'}}>‚ùå NO (0)</button></div>) : <p className="waiting-pulse">El Host valida...</p>}</div>)}
                </div>
            );
        };

        // ==========================================
        // JUEGO 1: DIAL (WAVELENGTH)
        // ==========================================
        const DialGame = ({ roomId, playerRole, roomData, onBack }) => {
            const game = roomData.dialGame || {};
            const isHostTurn = game.turn === 'host';
            const iAmPsychic = (isHostTurn && playerRole === 'host') || (!isHostTurn && playerRole === 'guest');
            const iAmGuesser = !iAmPsychic;

            const startTurn = () => {
                const nextTurn = (!game.turn || game.turn === 'guest') ? 'host' : 'guest';
                const topic = DIAL_TOPICS[Math.floor(Math.random() * DIAL_TOPICS.length)];
                const target = Math.floor(Math.random() * 140) + 20; 
                db.ref(`salas/${roomId}/dialGame`).set({ turn: nextTurn, topic, targetAngle: target, needleAngle: 90, phase: 'HINTING', hint: '', score: 0 });
            };
            const sendHint = (txt) => txt && db.ref(`salas/${roomId}/dialGame`).update({ hint: txt, phase: 'GUESSING' });
            const moveNeedle = (val) => iAmGuesser && game.phase === 'GUESSING' && db.ref(`salas/${roomId}/dialGame`).update({ needleAngle: parseInt(val) });
            const confirmGuess = () => {
                const currentVal = parseInt(document.getElementById('dialInput').value);
                const diff = Math.abs(game.targetAngle - currentVal);
                let pts = 0; if (diff <= 8) pts = 4; else if (diff <= 18) pts = 3; else if (diff <= 28) pts = 2;
                db.ref(`salas/${roomId}/dialGame`).update({ phase: 'RESULT', score: pts, needleAngle: currentVal });
            };

            if (!game.turn) return <div className="card"><h2>üåä El Dial</h2><button onClick={startTurn}>EMPEZAR</button><br/><button onClick={onBack} style={{background:'#555'}}>MEN√ö</button></div>;
            const needleRot = game.needleAngle - 90; const targetRot = game.targetAngle - 90; const showZone = iAmPsychic || game.phase === 'RESULT';

            return (
                <div className="card">
                    <button onClick={onBack} style={{padding:5, fontSize:12, width:'auto', background:'transparent', border:'1px solid #555', float:'right'}}>SALIR</button>
                    <div style={{clear:'both', marginBottom:10, fontSize:12, color:'#aaa'}}>TURNO: {isHostTurn ? roomData.players.host.name : roomData.players.guest.name}</div>
                    <div className="topic-card"><span style={{color:'#93c5fd', width:'45%', textAlign:'left'}}>‚¨ÖÔ∏è {game.topic[0]}</span><span style={{color:'#fda4af', width:'45%', textAlign:'right'}}>{game.topic[1]} ‚û°Ô∏è</span></div>
                    <div className="dial-main-container">
                        <div className="dial-mask"><div className="target-wedge-wrapper" style={{ transform: `rotate(${targetRot}deg)`, opacity: showZone ? 1 : 0 }}><div className="target-wedge-graphic"></div></div></div>
                        <div className="needle-container"><div className="needle" style={{ transform: `rotate(${needleRot}deg)` }}></div></div><div className="knob"></div>
                    </div>
                    {iAmPsychic && (game.phase === 'HINTING' ? <><p style={{color:'#be185d'}}>T√∫ ves la zona. ¬°Pista!</p><input id="h" placeholder="..." /><button onClick={()=>sendHint(document.getElementById('h').value)}>ENVIAR</button></> : (game.phase === 'RESULT' ? <><div className="score-big">+{game.score}</div><p className="waiting-pulse">Esperando...</p></> : <p className="waiting-pulse">Tu pareja juega...</p>))}
                    {iAmGuesser && (game.phase === 'GUESSING' ? <><div className="hint-display">"{game.hint}"</div><input id="dialInput" type="range" min="0" max="180" value={game.needleAngle} onChange={e=>moveNeedle(e.target.value)} style={{width:'100%', accentColor:'#ef4444', height:30}} /><button onClick={confirmGuess} style={{background:'#ef4444'}}>BLOQUEAR</button></> : (game.phase === 'RESULT' ? <><div className="score-big">+{game.score}</div><button onClick={startTurn}>SIGUIENTE</button></> : <p className="waiting-pulse">Esperando pista...</p>))}
                </div>
            );
        };

        // ==========================================
        // JUEGO 2: COLORES
        // ==========================================
        const ColorGame = ({ roomId, playerRole, roomData, onBack }) => {
            const game = roomData.colorGame || {};
            const isHostTurn = game.turn === 'host';
            const iAmGiver = (isHostTurn && playerRole === 'host') || (!isHostTurn && playerRole === 'guest');
            const iAmGuesser = !iAmGiver;
            const COLS=20, ROWS=15, LABELS="ABCDEFGHIJKLMNO".split('');
            const getColor = (r, c) => { const hue = Math.floor((360 / COLS) * c); let l=50,s=100; if(r<5){l=100-(r*10);s=50+(r*10);}else if(r>9){l=50-((r-9)*8);} return `hsl(${hue},${s}%,${l}%)`; };

            const startTurn = () => { const nextTurn = (!game.turn || game.turn === 'guest') ? 'host' : 'guest'; const r = Math.floor(Math.random()*ROWS), c = Math.floor(Math.random()*COLS); db.ref(`salas/${roomId}/colorGame`).set({ turn: nextTurn, target: {r, c, code: `${LABELS[r]}-${c+1}`}, step: 1, score: 0 }); };
            const sendHint = (txt) => txt && db.ref(`salas/${roomId}/colorGame`).update({ [`hints/h${game.step === 1 ? 1 : 2}`]: txt, step: game.step + 1, currentCursor: null });
            const touchGrid = (r, c) => iAmGuesser && (game.step === 2 || game.step === 4) && db.ref(`salas/${roomId}/colorGame`).update({ currentCursor: {r, c} });
            const confirmGuess = () => { if(!game.currentCursor) return; const update = { step: game.step+1, [`guesses/g${game.step===2?1:2}`]: game.currentCursor, currentCursor: null }; if(game.step===4){ const dist=Math.max(Math.abs(game.target.r-game.currentCursor.r),Math.abs(game.target.c-game.currentCursor.c)); update.score=dist===0?3:(dist<=1?2:(dist<=3?1:0)); } db.ref(`salas/${roomId}/colorGame`).update(update); };

            if (!game.turn) return <div className="card"><h2>üé® Colores</h2><button onClick={startTurn}>EMPEZAR</button><br/><button onClick={onBack} style={{background:'#555'}}>MEN√ö</button></div>;
            if (!game.target) return <div className="card">Cargando...</div>;

            return (
                <div className="card" style={{maxWidth:'100%', padding:10}}>
                    <button onClick={onBack} style={{padding:5, fontSize:12, width:'auto', background:'transparent', border:'1px solid #555', float:'right'}}>SALIR</button>
                    <div style={{clear:'both', marginBottom:10, fontSize:12, color:'#aaa'}}>TURNO: {isHostTurn ? roomData.players.host.name : roomData.players.guest.name} | PASO: {game.step}/5</div>
                    {iAmGiver && (game.step<5 ? <div><div style={{background:'#333', padding:5, marginBottom:5}}><div className="coord-box">{game.target.code}</div><div style={{height:15, background:getColor(game.target.r, game.target.c), width:'100%'}}></div></div> {(game.step===1||game.step===3)?<><input id="hin" placeholder={`Pista...`} /><button onClick={()=>sendHint(document.getElementById('hin').value)}>ENVIAR</button></>:<button onClick={confirmGuess} disabled={!game.currentCursor} style={{background:game.currentCursor?'#10b981':'#444'}}>CONFIRMAR</button>}</div> : null)}
                    {iAmGuesser && (game.step<5 ? <div>{(game.step===1||game.step===3)?<p className="waiting-pulse">Esperando pista...</p>:<><div className="hint-display">"{game.step===2?game.hints?.h1:game.hints?.h2}"</div><button onClick={confirmGuess} disabled={!game.currentCursor} style={{background:game.currentCursor?'#be185d':'#444'}}>{game.step===2?'CONFIRMAR 1':'CONFIRMAR FINAL'}</button></>}</div> : null)}
                    {game.step===5 && <div><div style={{fontSize:40, color: game.score===3?'#10b981':'#fbbf24'}}>+{game.score} PUNTOS</div>{iAmGuesser?<button onClick={startTurn}>SIGUIENTE</button>:<p className="waiting-pulse">Esperando...</p>}</div>}
                    <div className="grid-wrapper"><div className="color-grid">{Array.from({ length: COLS*ROWS }).map((_, i) => { const r=Math.floor(i/COLS), c=i%COLS; const isT=(iAmGiver||game.step===5)&&game.target.r===r&&game.target.c===c; const isC=game.currentCursor&&game.currentCursor.r===r&&game.currentCursor.c===c; let cls="color-cell"; if(isT) cls+=" target-star"; if(isC) cls+=" guess-mark-current"; return <div key={i} className={cls} style={{backgroundColor:getColor(r,c)}} onClick={()=>touchGrid(r,c)}></div>; })}</div></div>
                </div>
            );
        };

        // ==========================================
        // APP SHELL
        // ==========================================
        function App() {
            const [playerName, setPlayerName] = React.useState(localStorage.getItem('name') || '');
            const [roomId, setRoomId] = React.useState('');
            const [view, setView] = React.useState('lobby'); 
            const [roomData, setRoomData] = React.useState(null);
            const [showChat, setShowChat] = React.useState(false);
            const [chatMsg, setChatMsg] = React.useState('');
            const [msgs, setMsgs] = React.useState([]);

            React.useEffect(() => { localStorage.setItem('name', playerName); }, [playerName]);
            React.useEffect(() => { if (roomId) db.ref('salas/'+roomId).on('value', snap => { const d=snap.val(); if(d){ setRoomData(d); if(view==='waiting'&&d.players.guest) setView('game'); if(d.chat) setMsgs(Object.values(d.chat)); } }); }, [roomId, view]);

            const create = () => { const id=Math.random().toString(36).substr(2,4).toUpperCase(); db.ref('salas/'+id).set({players:{host:{name:playerName}}, gameState:'MENU'}); setRoomId(id); setView('waiting'); };
            const join = (c) => db.ref('salas/'+c).once('value', s => { if(s.exists()){ db.ref('salas/'+c+'/players/guest').set({name:playerName}); setRoomId(c); setView('game'); } });
            const sendC = () => chatMsg && db.ref('salas/'+roomId+'/chat').push({user:playerName, text:chatMsg}) && setChatMsg('');
            const setGame = (g) => db.ref(`salas/${roomId}`).update({ gameState: g });

            const ChatGlobal = roomId ? <><div className="chat-btn" onClick={()=>setShowChat(!showChat)}>üí¨</div>{showChat && <div className="chat-overlay"><div style={{flex:1,overflowY:'auto',padding:20,textAlign:'left',color:'white'}}>{msgs.map((m,i)=><div key={i}><b>{m.user}:</b> {m.text}</div>)}</div><div style={{display:'flex',padding:10,background:'#111'}}><input value={chatMsg} onChange={e=>setChatMsg(e.target.value)} style={{marginBottom:0,flex:1}} placeholder="..." /><button onClick={sendC} style={{width:'auto',margin:0,marginLeft:10}}>‚û§</button></div><button onClick={()=>setShowChat(false)} style={{margin:0,borderRadius:0,background:'#333'}}>CERRAR</button></div>}</> : null;

            if (view === 'lobby') return <div className="card"><h1>Parejas Ultimate ‚ù§Ô∏è</h1><input value={playerName} onChange={e=>setPlayerName(e.target.value)} placeholder="Tu Nombre" /><button onClick={create}>Crear Sala</button><br/><br/><input id="c" placeholder="C√ìDIGO" style={{textTransform:'uppercase'}} /><button style={{background:'#6366f1'}} onClick={()=>join(document.getElementById('c').value.toUpperCase())}>Unirse</button></div>;
            if (view === 'waiting') return <div className="card"><h2>{roomId}</h2><p className="waiting-pulse">Esperando a tu pareja...</p></div>;
            if (!roomData) return <div className="card">Cargando...</div>;
            const playerRole = roomData.players.host.name === playerName ? 'host' : 'guest';
            
            return (
                <div>
                    {ChatGlobal}
                    {roomData.gameState === 'MENU' && (
                        <div className="card">
                            <h3>Elige Juego</h3>
                            <button className="game-btn btn-cats" onClick={()=>setGame('CAT')}>üö´ NO DIGAS LO MISMO</button>
                            <button className="game-btn btn-dial" onClick={()=>setGame('DIAL')}>üåä EL DIAL</button>
                            <button className="game-btn btn-colors" onClick={()=>setGame('COLOR')}>üé® COLORES</button>
                            <button className="game-btn btn-mind" onClick={()=>setGame('MIND')}>‚òï CAF√â O T√â</button>
                        </div>
                    )}
                    {roomData.gameState === 'CAT' && <CategoryGame roomId={roomId} playerRole={playerRole} roomData={roomData} onBack={()=>setGame('MENU')} />}
                    {roomData.gameState === 'COLOR' && <ColorGame roomId={roomId} playerRole={playerRole} roomData={roomData} onBack={()=>setGame('MENU')} />}
                    {roomData.gameState === 'DIAL' && <DialGame roomId={roomId} playerRole={playerRole} roomData={roomData} onBack={()=>setGame('MENU')} />}
                    {roomData.gameState === 'MIND' && <MindGame roomId={roomId} playerRole={playerRole} roomData={roomData} onBack={()=>setGame('MENU')} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
