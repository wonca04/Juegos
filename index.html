<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juegos Parejas Pack ‚ù§Ô∏è</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* ESTILOS GENERALES (TEMA OSCURO) */
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #fce7f3; margin: 0; padding: 10px; text-align: center; }
        
        .card { background: #1e1e1e; padding: 15px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); max-width: 600px; margin: 10px auto; border: 1px solid #333; }
        
        button { width: 100%; padding: 14px; background: #be185d; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 15px; transition: 0.2s; cursor: pointer; }
        button:disabled { background: #444; color: #888; opacity: 0.5; }
        button:active { transform: scale(0.98); }
        
        input { width: 100%; padding: 12px; background: #333; border: 2px solid #555; border-radius: 10px; color: white; text-align: center; font-size: 16px; outline: none; margin-bottom: 10px; }
        input:focus { border-color: #be185d; }

        /* ESTILOS MENU SELECCI√ìN */
        .game-btn { padding: 20px; font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; border: 2px solid transparent; }
        .btn-colors { background: linear-gradient(45deg, #ef4444, #eab308, #3b82f6); }
        .btn-dial { background: linear-gradient(45deg, #4f46e5, #818cf8); }

        /* ESTILOS DIAL (WAVELENGTH) */
        .dial-container { position: relative; width: 300px; height: 160px; margin: 20px auto; overflow: hidden; }
        .dial-bg { width: 300px; height: 300px; background: conic-gradient(from 270deg, #374151 0deg, #374151 180deg, transparent 180deg); border-radius: 50%; position: absolute; top: 0; left: 0; transform: rotate(-90deg); }
        .target-zone { position: absolute; top: 0; left: 0; width: 300px; height: 300px; border-radius: 50%; background: conic-gradient(from 270deg, transparent 0deg, transparent calc(var(--deg) - 15deg), #fbbf24 calc(var(--deg) - 15deg), #f59e0b calc(var(--deg) - 5deg), #ef4444 calc(var(--deg) - 2deg), #ef4444 calc(var(--deg) + 2deg), #f59e0b calc(var(--deg) + 5deg), #fbbf24 calc(var(--deg) + 15deg), transparent calc(var(--deg) + 15deg)); transform: rotate(-90deg); opacity: 0; transition: opacity 0.5s; }
        .visible { opacity: 1; }
        .needle { width: 4px; height: 140px; background: #ef4444; position: absolute; bottom: -10px; left: 50%; transform-origin: bottom center; margin-left: -2px; transition: transform 0.1s linear; border-radius: 2px; box-shadow: 0 0 5px red; }
        .knob { width: 30px; height: 30px; background: #e5e7eb; border-radius: 50%; position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); z-index: 20; }
        .topic-card { background: #312e81; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #6366f1; margin-bottom: 10px; }

        /* ESTILOS COLORES */
        .grid-wrapper { overflow-x: auto; padding-bottom: 10px; display: flex; justify-content: center; }
        .color-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 1px; background: #000; padding: 2px; border-radius: 6px; min-width: 340px; }
        .color-cell { aspect-ratio: 1; border-radius: 1px; cursor: pointer; position: relative; }
        .coord-box { background: #be185d; padding: 2px 8px; border-radius: 4px; font-weight: bold; display: inline-block; font-size: 18px; margin-bottom: 5px; }
        .target-star::after { content: "‚òÖ"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 8px; pointer-events: none; text-shadow: 0 0 2px black; }
        .guess-mark-current { box-shadow: 0 0 0 2px white, 0 0 8px #be185d; z-index: 10; transform: scale(1.2); }
        .hint-display { background: #333; padding: 8px; border-radius: 6px; font-style: italic; border-left: 3px solid #be185d; text-align: left; margin: 5px 0; font-size: 14px; }
        
        /* NOTIFICACIONES */
        .waiting-pulse { color: #888; font-style: italic; animation: pulse 1.5s infinite; font-size: 14px; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        /* CHAT */
        .chat-btn { position: fixed; top: 10px; right: 10px; width: 40px; height: 40px; background: #be185d; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 100; border: 2px solid white; box-shadow: 0 2px 5px black; }
        .chat-overlay { position: fixed; bottom: 0; left: 0; right: 0; height: 50vh; background: #222; border-top: 2px solid #be185d; z-index: 99; display: flex; flex-direction: column; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCbKOu5vwGbowuI5CfbygKJtYujAKa6zJ0",
          authDomain: "juegos-tiktok.firebaseapp.com",
          databaseURL: "https://juegos-tiktok-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "juegos-tiktok",
          storageBucket: "juegos-tiktok.firebasestorage.app",
          messagingSenderId: "504168913042",
          appId: "1:504168913042:web:e9eba88e01f94bcc7a2e4b"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ==========================================
        // COMPONENTE 1: JUEGO DIAL (Wavelength)
        // ==========================================
        const TOPICS = [["Fr√≠o", "Caliente"], ["Feo", "Guapo"], ["Barato", "Caro"], ["In√∫til", "√ötil"], ["Aburrido", "Divertido"], ["Seco", "Mojado"], ["F√°cil", "Dif√≠cil"], ["Odiado", "Amado"], ["Basura", "Tesoro"], ["Blando", "Duro"]];

        const DialGame = ({ roomId, playerRole, roomData, onBack }) => {
            const game = roomData.dialGame || {};
            const isHostTurn = game.turn === 'host';
            const iAmPsychic = (isHostTurn && playerRole === 'host') || (!isHostTurn && playerRole === 'guest');
            const iAmGuesser = !iAmPsychic;

            const startTurn = () => {
                const nextTurn = (!game.turn || game.turn === 'guest') ? 'host' : 'guest';
                const topic = TOPICS[Math.floor(Math.random() * TOPICS.length)];
                const target = Math.floor(Math.random() * 160) + 10; 
                db.ref(`salas/${roomId}/dialGame`).set({ turn: nextTurn, topic, targetAngle: target, needleAngle: 90, phase: 'HINTING', hint: '', score: 0 });
            };

            const sendHint = (txt) => txt && db.ref(`salas/${roomId}/dialGame`).update({ hint: txt, phase: 'GUESSING' });
            const moveNeedle = (val) => iAmGuesser && game.phase === 'GUESSING' && db.ref(`salas/${roomId}/dialGame`).update({ needleAngle: parseInt(val) });
            const confirmGuess = () => {
                let pts = 0, diff = Math.abs(game.targetAngle - game.needleAngle);
                if (diff <= 4) pts = 4; else if (diff <= 12) pts = 3; else if (diff <= 22) pts = 2;
                db.ref(`salas/${roomId}/dialGame`).update({ phase: 'RESULT', score: pts });
            };

            if (!game.turn) return <div className="card"><h2>üåä El Dial</h2><button onClick={startTurn}>EMPEZAR</button><br/><button onClick={onBack} style={{background:'#555'}}>VOLVER AL MEN√ö</button></div>;

            return (
                <div className="card">
                    <button onClick={onBack} style={{padding:5, fontSize:12, width:'auto', background:'transparent', border:'1px solid #555', float:'right'}}>SALIR</button>
                    <div style={{clear:'both', marginBottom:10, fontSize:12, color:'#aaa'}}>TURNO: {isHostTurn ? roomData.players.host.name : roomData.players.guest.name}</div>
                    
                    <div className="topic-card"><span style={{color:'#93c5fd'}}>{game.topic[0]}</span><span>vs</span><span style={{color:'#fda4af'}}>{game.topic[1]}</span></div>

                    <div className="dial-container">
                        <div className="dial-bg"></div>
                        <div className={`target-zone ${(iAmPsychic || game.phase === 'RESULT') ? 'visible' : ''}`} style={{ '--deg': `${game.targetAngle}deg` }}></div>
                        <div className="needle" style={{ transform: `rotate(${game.needleAngle - 90}deg)` }}></div>
                        <div className="knob"></div>
                    </div>

                    {iAmPsychic && (
                        <div>
                            {game.phase === 'HINTING' && <><input id="h" placeholder="Tu pista..." /><button onClick={()=>sendHint(document.getElementById('h').value)}>ENVIAR PISTA</button></>}
                            {game.phase === 'GUESSING' && <p className="waiting-pulse">Tu pareja est√° moviendo la aguja...</p>}
                            {game.phase === 'RESULT' && <p>Puntuaci√≥n: {game.score}</p>}
                        </div>
                    )}
                    {iAmGuesser && (
                        <div>
                            {game.phase === 'HINTING' && <p className="waiting-pulse">Esperando pista...</p>}
                            {game.phase === 'GUESSING' && <><div className="hint-display" style={{textAlign:'center'}}>"{game.hint}"</div><input type="range" min="0" max="180" value={game.needleAngle} onChange={e=>moveNeedle(e.target.value)} style={{width:'100%', accentColor:'#ef4444'}} /><button onClick={confirmGuess} style={{background:'#ef4444'}}>BLOQUEAR</button></>}
                            {game.phase === 'RESULT' && <><div style={{fontSize:40, color:'#fbbf24'}}>+{game.score}</div><button onClick={startTurn}>SIGUIENTE</button></>}
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // COMPONENTE 2: JUEGO COLORES
        // ==========================================
        const ColorGame = ({ roomId, playerRole, roomData, onBack }) => {
            const game = roomData.colorGame || {};
            const isHostTurn = game.turn === 'host';
            const iAmGiver = (isHostTurn && playerRole === 'host') || (!isHostTurn && playerRole === 'guest');
            const iAmGuesser = !iAmGiver;
            const COLS=20, ROWS=15, LABELS="ABCDEFGHIJKLMNO".split('');

            const getColor = (r, c) => {
                const hue = Math.floor((360 / COLS) * c);
                let l = 50, s = 100;
                if (r < 5) { l = 100 - (r * 10); s = 50 + (r * 10); } else if (r > 9) { l = 50 - ((r - 9) * 8); }
                return `hsl(${hue}, ${s}%, ${l}%)`;
            };

            const startTurn = () => {
                const nextTurn = (!game.turn || game.turn === 'guest') ? 'host' : 'guest';
                const r = Math.floor(Math.random() * ROWS), c = Math.floor(Math.random() * COLS);
                db.ref(`salas/${roomId}/colorGame`).set({ turn: nextTurn, target: {r, c, code: `${LABELS[r]}-${c+1}`}, step: 1, score: 0 });
            };

            const sendHint = (txt) => txt && db.ref(`salas/${roomId}/colorGame`).update({ [`hints/h${game.step === 1 ? 1 : 2}`]: txt, step: game.step + 1, currentCursor: null });
            const touchGrid = (r, c) => iAmGuesser && (game.step === 2 || game.step === 4) && db.ref(`salas/${roomId}/colorGame`).update({ currentCursor: {r, c} });
            
            const confirmGuess = () => {
                if(!game.currentCursor) return;
                const nextStep = game.step + 1;
                const update = { step: nextStep, [`guesses/g${game.step===2?1:2}`]: game.currentCursor, currentCursor: null };
                if (game.step === 4) {
                    const dist = Math.max(Math.abs(game.target.r - game.currentCursor.r), Math.abs(game.target.c - game.currentCursor.c));
                    update.score = dist === 0 ? 3 : (dist <= 1 ? 2 : (dist <= 3 ? 1 : 0));
                }
                db.ref(`salas/${roomId}/colorGame`).update(update);
            };

            if (!game.turn) return <div className="card"><h2>üé® Colores</h2><button onClick={startTurn}>EMPEZAR</button><br/><button onClick={onBack} style={{background:'#555'}}>VOLVER AL MEN√ö</button></div>;
            if (!game.target) return <div className="card">Cargando...</div>;

            return (
                <div className="card" style={{maxWidth:'100%', padding:10}}>
                    <button onClick={onBack} style={{padding:5, fontSize:12, width:'auto', background:'transparent', border:'1px solid #555', float:'right'}}>SALIR</button>
                    <div style={{clear:'both', marginBottom:10, fontSize:12, color:'#aaa'}}>TURNO: {isHostTurn ? roomData.players.host.name : roomData.players.guest.name} | PASO: {game.step}/5</div>
                    
                    {iAmGiver && (
                        <div>
                            {game.step < 5 && <div style={{background:'#333', padding:5, marginBottom:5}}><div className="coord-box">{game.target.code}</div><div style={{height:15, background:getColor(game.target.r, game.target.c), width:'100%'}}></div></div>}
                            {(game.step===1 || game.step===3) && <><input id="hin" placeholder={`Pista ${game.step===1?1:2}...`} /><button onClick={()=>sendHint(document.getElementById('hin').value)}>ENVIAR</button></>}
                            {(game.step===2 || game.step===4) && <button onClick={confirmGuess} disabled={!game.currentCursor} style={{background: game.currentCursor?'#10b981':'#444'}}>CONFIRMAR ELECCI√ìN</button>}
                        </div>
                    )}
                    {iAmGuesser && (
                        <div>
                            {(game.step===1 || game.step===3) && <p className="waiting-pulse">Esperando pista...</p>}
                            {(game.step===2 || game.step===4) && <><div className="hint-display">"{game.step===2 ? game.hints?.h1 : game.hints?.h2}"</div><p style={{color:'#10b981', margin:5}}>¬°TOCA EL MAPA!</p></>}
                            {(game.step===2 || game.step===4) && <button onClick={confirmGuess} disabled={!game.currentCursor} style={{background: game.currentCursor?'#be185d':'#444'}}>{game.step===2?'CONFIRMAR PRIMERA':'CONFIRMAR FINAL'}</button>}
                        </div>
                    )}
                    {game.step === 5 && (
                        <div><div style={{fontSize:40, color: game.score===3?'#10b981':'#fbbf24'}}>+{game.score} PUNTOS</div><div style={{display:'flex',justifyContent:'center', gap:5}}><div className="coord-box" style={{fontSize:14}}>{game.target.code}</div><div style={{width:20, height:20, background:getColor(game.target.r, game.target.c)}}></div></div>
                        {iAmGuesser ? <button onClick={startTurn}>SIGUIENTE</button> : <p className="waiting-pulse">Esperando...</p>}</div>
                    )}

                    <div className="grid-wrapper">
                        <div className="color-grid">
                            {Array.from({ length: COLS * ROWS }).map((_, i) => {
                                const r = Math.floor(i / COLS), c = i % COLS;
                                const isTarget = (iAmGiver || game.step === 5) && game.target.r === r && game.target.c === c;
                                const isCur = game.currentCursor && game.currentCursor.r === r && game.currentCursor.c === c;
                                const isG1 = game.guesses?.g1 && game.guesses.g1.r === r && game.guesses.g1.c === c;
                                let cls = "color-cell";
                                if (isTarget) cls += " target-star";
                                if (isCur) cls += " guess-mark-current";
                                return <div key={i} className={cls} style={{ backgroundColor: getColor(r, c), border: isG1 ? '1px solid rgba(255,255,255,0.5)' : 'none' }} onClick={() => touchGrid(r, c)}></div>;
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // APP PRINCIPAL (Lobby + Selector)
        // ==========================================
        function App() {
            const [playerName, setPlayerName] = React.useState(localStorage.getItem('name') || '');
            const [roomId, setRoomId] = React.useState('');
            const [view, setView] = React.useState('lobby'); // lobby, waiting, game
            const [roomData, setRoomData] = React.useState(null);
            const [showChat, setShowChat] = React.useState(false);
            const [chatMsg, setChatMsg] = React.useState('');
            const [msgs, setMsgs] = React.useState([]);

            React.useEffect(() => { localStorage.setItem('name', playerName); }, [playerName]);
            React.useEffect(() => {
                if (roomId) {
                    db.ref('salas/' + roomId).on('value', snap => {
                        const d = snap.val();
                        if (d) {
                            setRoomData(d);
                            if (view === 'waiting' && d.players.guest) setView('game'); // Auto-entrar
                            if (d.chat) setMsgs(Object.values(d.chat));
                        }
                    });
                }
            }, [roomId, view]);

            const create = () => { const id=Math.random().toString(36).substr(2,4).toUpperCase(); db.ref('salas/'+id).set({players:{host:{name:playerName}}, gameState:'MENU'}); setRoomId(id); setView('waiting'); };
            const join = (c) => db.ref('salas/'+c).once('value', s => { if(s.exists()){ db.ref('salas/'+c+'/players/guest').set({name:playerName}); setRoomId(c); setView('game'); } });
            const sendC = () => chatMsg && db.ref('salas/'+roomId+'/chat').push({user:playerName, text:chatMsg}) && setChatMsg('');
            
            const setGame = (g) => db.ref(`salas/${roomId}`).update({ gameState: g });

            // RENDER
            if (view === 'lobby') return (
                <div className="card"><h1>Juegos Parejas ‚ù§Ô∏è</h1><input value={playerName} onChange={e=>setPlayerName(e.target.value)} placeholder="Tu Nombre" /><button onClick={create}>Crear Sala</button><br/><br/><input id="c" placeholder="C√ìDIGO" style={{textTransform:'uppercase'}} /><button style={{background:'#6366f1'}} onClick={()=>join(document.getElementById('c').value.toUpperCase())}>Unirse</button></div>
            );

            if (view === 'waiting') return <div className="card"><h2>{roomId}</h2><p className="waiting-pulse">Esperando a tu pareja...</p></div>;

            // DENTRO DE LA SALA
            if (!roomData) return <div className="card">Cargando...</div>;
            const playerRole = roomData.players.host.name === playerName ? 'host' : 'guest';
            
            // Si el estado es MENU, mostramos los botones
            if (roomData.gameState === 'MENU') return (
                <div>
                    {roomId && <><div className="chat-btn" onClick={()=>setShowChat(!showChat)}>üí¨</div>{showChat && <div className="chat-overlay"><div style={{flex:1,overflowY:'auto',padding:10,textAlign:'left'}}>{msgs.map((m,i)=><div key={i}><b>{m.user}:</b> {m.text}</div>)}</div><div style={{display:'flex',padding:10}}><input value={chatMsg} onChange={e=>setChatMsg(e.target.value)} style={{marginBottom:0,flex:1}} /><button onClick={sendC} style={{width:'auto',margin:0}}>‚û§</button></div><button onClick={()=>setShowChat(false)} style={{margin:0,borderRadius:0}}>CERRAR</button></div>}</>}
                    
                    <div className="card">
                        <h3>Elige a qu√© jugar</h3>
                        <button className="game-btn btn-colors" onClick={()=>setGame('COLOR')}>üé® COLORES</button>
                        <button className="game-btn btn-dial" onClick={()=>setGame('DIAL')}>üåä EL DIAL</button>
                    </div>
                </div>
            );

            // Si hay un juego seleccionado
            if (roomData.gameState === 'COLOR') return <ColorGame roomId={roomId} playerRole={playerRole} roomData={roomData} onBack={()=>setGame('MENU')} />;
            if (roomData.gameState === 'DIAL') return <DialGame roomId={roomId} playerRole={playerRole} roomData={roomData} onBack={()=>setGame('MENU')} />;
            
            return <div>Error de estado</div>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
